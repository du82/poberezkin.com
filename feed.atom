<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <title>Evgeny Poberezkin</title>
    <link href="https://www.poberezkin.com/feed.atom" rel="self" />
    <link href="https://www.poberezkin.com" />
    <id>https://www.poberezkin.com/feed.atom</id>
    <author>
        <name>Evgeny Poberezkin</name>
        <email>evgeny@poberezkin.com</email>
    </author>
    <updated>2020-06-29T00:00:00Z</updated>
    <entry>
    <title>Modeling state machines with dependent types in Haskell: Part 1</title>
    <link href="https://www.poberezkin.com/posts/2020-06-29-modeling-state-machine-dependent-types-haskell-1.html" />
    <id>https://www.poberezkin.com/posts/2020-06-29-modeling-state-machine-dependent-types-haskell-1.html</id>
    <published>2020-06-29T00:00:00Z</published>
    <updated>2020-06-29T00:00:00Z</updated>
    <summary type="html"><![CDATA[<article>
  <section class="header">
    <div class="info">
      Posted on
      
        June 29, 2020
      
      
        by Evgeny Poberezkin
      
    </div>
    <div class="info">
      
        Tags: <a title="All pages tagged &#39;haskell&#39;." href="/tags/haskell.html">haskell</a>, <a title="All pages tagged &#39;executable&#39;." href="/tags/executable.html">executable</a>, <a title="All pages tagged &#39;coding&#39;." href="/tags/coding.html">coding</a>
      
    </div>
  </section>
  <section>
    <p>This post is “literate” haskell (thanks to <a href="https://github.com/sol/markdown-unlit">markdown-unlit</a>), it can be run on GHC 8.8.3 with <code>stack run elevator</code>.</p>
<h2 id="why">Why?</h2>
<p>The reason to use types to model state transitions is to guarantee the correctness of <a href="https://en.wikipedia.org/wiki/Finite-state_machine">state machine</a> implementation by the way it is constructed, so that invalid implementations fail to compile.</p>
<p>When we model a state machine we usually create some diagram or use some meta-language to show allowed state transitions. The code implementing the logic of the state machine is disconnected from this diagram, and it can be large enough to make it impossible or very difficult to validate that the implementation only supports allowed state transitions.</p>
<p>We could use some DSL or library to raise the level of abstraction so that allowed state transitions are more visible in code. It mitigates the problem, but it creates additional complexity and dependency on the component (DSL interpreter or state-machine library) that also can have implementation mistakes.</p>
<p>Modeling state transition in types offers a simple alternative to ensure that only allowed state transitions can be implemented - the code that attempts to perform the state transition that is not allowed will not compile.</p>
<h2 id="how">How?</h2>
<p>Using parametrized types it is possible to express state machine transitions where state can be part of the transition type. Further, using <a href="https://en.wikipedia.org/wiki/Dependent_type">dependent types</a> it is possible to make transitions depend on some run time states. Haskell does not support dependent types directly, but it is possible to have an equivalent of dependent types with singleton types and <a href="https://hackage.haskell.org/package/singletons">singletons</a> - see <a href="2020-05-17-using-dependent-types-haskell-singletons.html">this post</a>.</p>
<h2 id="modeling-elevator-aka-lift-states">Modeling elevator (aka lift) states</h2>
<p>We will model state transition of a simplified <a href="https://en.wikipedia.org/wiki/Elevator">elevator</a> state changes.</p>
<p>The state of the elevator has 3 dimensions: its door can be opened or closed, it can be stopped or going up or down, and it can be on different floors. Not all combinations are allowed though - the elevator must not move with the opened door and it must not open the door while moving. Elevator states and allowed actions and states are shown on the diagram.</p>
<p><a href="https://github.com/epoberezkin/poberezkin.com/tree/master/dot/elevator.gv"><img src="/images/elevator.svg" title="source" alt="Elevator states" /></a></p>
<p>In addition to that elevator cannot go below than the ground floor (type-level natural number <code>0</code> will be used for it).</p>
<p>To have the state of the elevator available both in types, and also at run-time we will use singletons library and we will need to enable some GHC extensions:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a><span class="ot">{-# LANGUAGE ConstraintKinds, DataKinds, DeriveAnyClass, EmptyCase, </span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true"></a><span class="ot">  FlexibleContexts, FlexibleInstances, FunctionalDependencies, GADTs, </span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true"></a><span class="ot">  InstanceSigs, LambdaCase, PartialTypeSignatures, PolyKinds, RankNTypes, </span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true"></a><span class="ot">  ScopedTypeVariables, StandaloneDeriving, TemplateHaskell, </span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true"></a><span class="ot">  TypeApplications, TypeFamilies, TypeOperators, UndecidableInstances #-}</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true"></a><span class="ot">{-# OPTIONS_GHC -Werror=incomplete-patterns #-}</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true"></a><span class="ot">{-# OPTIONS_GHC -fno-warn-unticked-promoted-constructors #-}</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true"></a><span class="kw">import</span> <span class="dt">Data.Kind</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true"></a><span class="kw">import</span> <span class="dt">Data.Singletons</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true"></a><span class="kw">import</span> <span class="dt">Data.Singletons.Prelude</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true"></a><span class="kw">import</span> <span class="dt">Data.Singletons.TH</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true"></a><span class="kw">import</span> <span class="dt">Data.Singletons.TypeLits</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true"></a><span class="kw">import</span> <span class="dt">System.IO</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true"></a><span class="kw">import</span> <span class="dt">System.IO.Interact</span></span></code></pre></div>
<p>We will define the state of the elevator door and movement in types, and also create singleton types for them:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a><span class="op">$</span>(singletons [d|</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true"></a>  data DoorState = Opened | Closed</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true"></a>    deriving (Show, Read, Eq)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true"></a>  data MoveState = Stopped | Up | Down</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true"></a>    deriving (Show, Read, Eq)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true"></a>  |])</span></code></pre></div>
<p><a href="2020-05-17-using-dependent-types-haskell-singletons.html">This post</a> shows what singletons library does when you wrap type definitions like that. If you did not use singletons before, you can read an <a href="https://blog.jle.im/entry/introduction-to-singletons-1.html">introduction to singletons library</a> by Justin Le.</p>
<p>We also need to define dependent state changes both in types and at run-time. For that we will need type families and functions on singletons that can also be created with singletons library:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true"></a><span class="op">$</span>(singletonsOnly [d|</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true"></a>  nextFloor :: MoveState -&gt; Nat -&gt; Nat</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true"></a>  nextFloor Stopped f = f</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true"></a>  nextFloor Up f = f + 1</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true"></a>  nextFloor Down f =</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true"></a>    if f &gt; 0</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true"></a>      then f - 1</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true"></a>      else 0</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true"></a>  nextMoveState :: MoveState -&gt; Nat -&gt; MoveState</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true"></a>  nextMoveState Stopped _ = Stopped</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true"></a>  nextMoveState Up _ = Up</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true"></a>  nextMoveState Down f =</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true"></a>    if f &lt;= 1</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true"></a>      then Stopped</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true"></a>      else Down</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true"></a>  |])</span></code></pre></div>
<p>The two functions above define that the floor should increase when the elevator is going up, and decrease when it is going down, but not below <code>0</code> (<code>nextFloor</code>) and that when the elevator reaches the ground floor it should stop (<code>nextMoveState</code>).</p>
<p>Singletons library generates code that adds type families <code>NextFloor</code> and <code>NextMoveState</code> to the above declaration and equivalent functions on singletons (<code>sNextFloor</code> and <code>sNextMoveState</code>). They are defined similarly to the below (but you do not need to add this code - it is added automatically):</p>
<pre class="haskell-ignore"><code>type family NextFloor (m :: MoveState) (f :: Nat) :: Nat where
  NextFloor Stopped f = f
  NextFloor Up f = f + 1
  NextFloor Down f =
    If (f &gt; 1) (f - 1) 0

sNextMoveState ::
  Sing (m :: MoveState) -&gt; Sing (f :: Nat) -&gt; Sing (NextFloor m f)</code></pre>
<p>etc. The actual generated code is a bit more complex.</p>
<p>Now we can define the type for allowed elevator actions:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true"></a><span class="kw">infixr</span> <span class="dv">2</span> <span class="op">:&gt;&gt;</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true"></a><span class="kw">type</span> <span class="dt">Elevator</span> <span class="ot">=</span> (<span class="dt">DoorState</span>, <span class="dt">MoveState</span>, <span class="dt">Nat</span>)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true"></a><span class="kw">type</span> <span class="kw">family</span> <span class="dt">Moving</span> (<span class="ot">m ::</span> <span class="dt">MoveState</span>)<span class="ot"> ::</span> <span class="dt">Constraint</span> <span class="kw">where</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true"></a>  <span class="dt">Moving</span> <span class="dt">Up</span> <span class="ot">=</span> ()</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true"></a>  <span class="dt">Moving</span> <span class="dt">Down</span> <span class="ot">=</span> ()</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true"></a><span class="kw">data</span> <span class="dt">Action</span> (<span class="ot">s ::</span> <span class="dt">Elevator</span>) (<span class="ot">s&#39; ::</span> <span class="dt">Elevator</span>)<span class="ot"> ::</span> <span class="dt">Type</span> <span class="kw">where</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true"></a>  <span class="dt">Open</span> <span class="ot">::</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true"></a>    <span class="dt">Action</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true"></a>      &#39;(<span class="dt">Closed</span>, <span class="dt">Stopped</span>, f)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true"></a>      &#39;(<span class="dt">Opened</span>, <span class="dt">Stopped</span>, f)</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true"></a>  <span class="dt">Close</span> <span class="ot">::</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true"></a>    <span class="dt">Action</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true"></a>      &#39;(<span class="dt">Opened</span>, <span class="dt">Stopped</span>, f)</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true"></a>      &#39;(<span class="dt">Closed</span>, <span class="dt">Stopped</span>, f)</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true"></a>  <span class="dt">Move</span> <span class="ot">::</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true"></a>    <span class="dt">Moving</span> m <span class="ot">=&gt;</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true"></a>    <span class="dt">Sing</span> (<span class="ot">m ::</span> <span class="dt">MoveState</span>) <span class="ot">-&gt;</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true"></a>    <span class="dt">Action</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true"></a>      &#39;(<span class="dt">Closed</span>, <span class="dt">Stopped</span>, f)</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true"></a>      &#39;(<span class="dt">Closed</span>, <span class="dt">NextMoveState</span> m f, <span class="dt">NextFloor</span> m f)</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true"></a>  <span class="dt">Stop</span> <span class="ot">::</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true"></a>    <span class="dt">Action</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true"></a>      &#39;(<span class="dt">Closed</span>, m, f)</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true"></a>      &#39;(<span class="dt">Closed</span>, <span class="dt">Stopped</span>, f)</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true"></a>  <span class="dt">Wait</span> <span class="ot">::</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true"></a>    <span class="dt">Action</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true"></a>      &#39;(d, m, f)</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true"></a>      &#39;(d, <span class="dt">NextMoveState</span> m f, <span class="dt">NextFloor</span> m f)</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true"></a><span class="ot">  (:&gt;&gt;) ::</span> <span class="dt">Action</span> s1 s2 <span class="ot">-&gt;</span> <span class="dt">Action</span> s2 s3 <span class="ot">-&gt;</span> <span class="dt">Action</span> s1 s3</span></code></pre></div>
<p><code>Action</code> type is defined as generalized algebraic data type and it includes elevator state before and after the action as type-level tuples. Another alternative would be to parametrize <code>Action</code> on 6 separate parameters, but it would be more difficult to manage.</p>
<p><code>Move</code> constructor takes parameter that should be <code>SUp</code> or <code>SDown</code> (singletons for <code>Up</code> and <code>Down</code>) and type family <code>Moving</code> ensures that <code>SStoped</code> cannot be used here.</p>
<p>As actions can only be created using one of the available constructors, only allowed actions can be created. For example, the door can only be opened if it is closed and if the elevator is stopped. And the elevator can only start moving only if the door is closed.</p>
<p><code>Wait</code> action lets the elevator to go up and down, and it will also stop the elevator when it reaches the ground floor.</p>
<p><code>:&gt;&gt;</code> constructor allows to sequence actions, but only in such way that the final state of the first action is the same as the initial state of the second action. It also defines that the resulting compound action starts from the initial state of the first action and ends with the final state of the second action, in this way ensuring the continuity of state transitions.</p>
<p>With this type definition we expressed the original requirements in types without any executable code. The code using these types will not need tests to ensure the validity of state transitions, because we can only create allowed actions and we can only chain actions in a way that state changes are sequential, otherwise the code will not compile.</p>
<p>We can create a small “program” for the elevator to perform a sequence of actions:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true"></a><span class="kw">type</span> <span class="dt">ElevatorProgram</span> f f&#39; <span class="ot">=</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true"></a>  <span class="dt">Action</span> &#39;(<span class="dt">Opened</span>, <span class="dt">Stopped</span>, f) &#39;(<span class="dt">Opened</span>, <span class="dt">Stopped</span>, f&#39;)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true"></a><span class="ot">program ::</span> <span class="dt">ElevatorProgram</span> <span class="dv">0</span> <span class="dv">0</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true"></a>program <span class="ot">=</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true"></a>  <span class="dt">Close</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true"></a>  <span class="op">:&gt;&gt;</span> <span class="dt">Move</span> <span class="dt">SUp</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true"></a>  <span class="op">:&gt;&gt;</span> <span class="dt">Wait</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true"></a>  <span class="op">:&gt;&gt;</span> <span class="dt">Wait</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true"></a>  <span class="op">:&gt;&gt;</span> <span class="dt">Stop</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true"></a>  <span class="op">:&gt;&gt;</span> <span class="dt">Open</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true"></a>  <span class="op">:&gt;&gt;</span> <span class="dt">Close</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true"></a>  <span class="op">:&gt;&gt;</span> <span class="dt">Move</span> <span class="dt">SDown</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true"></a>  <span class="op">:&gt;&gt;</span> <span class="dt">Wait</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true"></a>  <span class="op">:&gt;&gt;</span> <span class="dt">Wait</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true"></a>  <span class="op">:&gt;&gt;</span> <span class="dt">Stop</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true"></a>  <span class="op">:&gt;&gt;</span> <span class="dt">Open</span></span></code></pre></div>
<p>This sequence of actions has type <code>Action '(Opened, Stopped, 0) '(Opened, Stopped, 0)</code> - the elevator starts and ends on the ground floor, with the opened door and stopped. If you try to write a program that performs the sequence of actions that is not allowed, it will not compile:</p>
<pre class="haskell-ignore"><code>badElevator :: ElevatorProgram 0 1
badElevator =
  Close
  :&gt;&gt; Move SUp
  -- Stop
  :&gt;&gt; Open</code></pre>
<p>The error message will be:</p>
<pre><code>    • Couldn&#39;t match type ‘&#39;Up’ with ‘&#39;Stopped’
      Expected type: Action
                       &#39;( &#39;Closed, &#39;Stopped, 0) &#39;( &#39;Closed, &#39;Stopped, 1)
        Actual type: Action
                       &#39;( &#39;Closed, &#39;Stopped, 0)
                       &#39;( &#39;Closed, NextMoveState &#39;Up 0, NextFloor &#39;Up 0)
    • In the first argument of ‘(:&gt;&gt;)’, namely ‘Move SUp’
      In the second argument of ‘(:&gt;&gt;)’, namely ‘Move SUp :&gt;&gt; Open’
      In the expression: Close :&gt;&gt; Move SUp :&gt;&gt; Open
    |
... |     :&gt;&gt; Move SUp</code></pre>
<p>It almost literally says that “to open door, the elevator must be stopped, it cannot be moving up”! So the correctness of state transitions is ensured by the way the type is defined.</p>
<p>To “fix” the program you just need to add <code>Stop</code> before <code>Open</code>.</p>
<h2 id="whats-the-point">What’s the point?</h2>
<p>We have the program, but what can we do with it? It is not code, so we cannot just run it.</p>
<p>We can interpret this program in different contexts - for that we need to write interpreter. For example, one of the interpreters can be just printing this program to console:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true"></a><span class="ot">printElevator ::</span> <span class="dt">Action</span> s s&#39; <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true"></a>printElevator <span class="dt">Open</span> <span class="ot">=</span> <span class="fu">putStrLn</span> <span class="st">&quot;open&quot;</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true"></a>printElevator <span class="dt">Close</span> <span class="ot">=</span> <span class="fu">putStrLn</span> <span class="st">&quot;close&quot;</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true"></a>printElevator (<span class="dt">Move</span> m) <span class="ot">=</span> <span class="kw">case</span> m <span class="kw">of</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true"></a>  <span class="dt">SUp</span> <span class="ot">-&gt;</span> <span class="fu">putStrLn</span> <span class="st">&quot;up&quot;</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true"></a>  _ <span class="ot">-&gt;</span> <span class="fu">putStrLn</span> <span class="st">&quot;down&quot;</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true"></a>printElevator <span class="dt">Stop</span> <span class="ot">=</span> <span class="fu">putStrLn</span> <span class="st">&quot;stop&quot;</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true"></a>printElevator <span class="dt">Wait</span> <span class="ot">=</span> <span class="fu">putStrLn</span> <span class="st">&quot;wait&quot;</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true"></a>printElevator (a <span class="op">:&gt;&gt;</span> prog) <span class="ot">=</span> printElevator a <span class="op">&gt;&gt;</span> printElevator prog</span></code></pre></div>
<p>The same approach can be used in real code - there could be an interpreter to control the real elevator. But it is now safe, as by defining allowed operations on the type level we ensured that we cannot perform unsafe actions - opening the door while the elevator is moving, or starting to move without closing the door.</p>
<h2 id="how-to-make-it-interactive">How to make it interactive?</h2>
<p>In some situations this can be useful and real programs can be written in this way - we achieved the possibility to restrict allowed operations in type system.</p>
<p>But how can we make this elevator interactive, so it can respond to the passengers’ commands? These commands are just data, so we need a way to move between data and types.</p>
<p>We will use singletons for the elevator state - they have type <code>Sing (s :: Elevator)</code>. We defined <code>Elevator</code> as a type synonym for the tuple of type <code>(DoorState, MoveState, Nat)</code> and we do not need anything special to use singletons for this type - as we have created singletons for our types <code>DoorState</code> and <code>MoveState</code>, singletons library defines singletons for all standard derived types, including tuples.</p>
<p>Because we want to create elevator actions at run time, from passenger commands, we will also need the existential wrapper for the typed action:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true"></a><span class="kw">data</span> <span class="dt">SomeAction</span> <span class="kw">where</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true"></a>  <span class="dt">SomeAction</span><span class="ot"> ::</span> <span class="dt">Action</span> s s&#39; <span class="ot">-&gt;</span> <span class="dt">Sing</span> s <span class="ot">-&gt;</span> <span class="dt">Sing</span> s&#39; <span class="ot">-&gt;</span> <span class="dt">SomeAction</span></span></code></pre></div>
<p>The action constructor includes the action itself and its initial and final states, so we can pattern match on them.</p>
<p>Now if we have the initial state and the action, we can both check that the action is compatible with it and get its final state:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true"></a><span class="ot">finalState ::</span> <span class="dt">SomeSing</span> <span class="dt">Elevator</span> <span class="ot">-&gt;</span> <span class="dt">SomeAction</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> (<span class="dt">SomeSing</span> <span class="dt">Elevator</span>)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true"></a>finalState (<span class="dt">SomeSing</span> s1) (<span class="dt">SomeAction</span> _ s1&#39; s2) <span class="ot">=</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true"></a>  <span class="kw">case</span> s1 <span class="op">%~</span> s1&#39; <span class="kw">of</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true"></a>    <span class="dt">Proved</span> <span class="dt">Refl</span> <span class="ot">-&gt;</span> <span class="dt">Just</span> (<span class="dt">SomeSing</span> s2)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true"></a>    _ <span class="ot">-&gt;</span> <span class="dt">Nothing</span></span></code></pre></div>
<p><code>%~</code> compares types of singletons <code>s1</code> and <code>s1'</code> and returns <code>Proved Refl</code> if they are the same. In this case we could have also converted both singletons to their base types and compare using <code>fromSing s1 == fromSing s1'</code> but it will not work in the contexts where type equality should be established, and not only value equality.</p>
<p>The following function creates the elevator action from the passenger’s commands. We also need to pass the initial state, both to make sure that the action is allowed and also to create actions with specific types, as all constructors are polymorphic:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true"></a><span class="ot">actionFromString ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">SomeSing</span> <span class="dt">Elevator</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">SomeAction</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true"></a>actionFromString name (<span class="dt">SomeSing</span> st) <span class="ot">=</span> action name st</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true"></a>  <span class="kw">where</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true"></a><span class="ot">    act ::</span> <span class="dt">Action</span> s s&#39; <span class="ot">-&gt;</span> <span class="dt">Sing</span> s <span class="ot">-&gt;</span> <span class="dt">Sing</span> s&#39; <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">SomeAction</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true"></a>    act a s1 s2 <span class="ot">=</span> <span class="dt">Just</span> <span class="op">$</span> <span class="dt">SomeAction</span> a s1 s2</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true"></a><span class="ot">    action ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Sing</span> (<span class="ot">s ::</span> <span class="dt">Elevator</span>) <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">SomeAction</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true"></a>    action <span class="st">&quot;open&quot;</span> s<span class="op">@</span>(<span class="dt">STuple3</span> <span class="dt">SClosed</span> <span class="dt">SStopped</span> f) <span class="ot">=</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true"></a>      act <span class="dt">Open</span> s (<span class="dt">STuple3</span> <span class="dt">SOpened</span> <span class="dt">SStopped</span> f)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true"></a>    action <span class="st">&quot;close&quot;</span> s<span class="op">@</span>(<span class="dt">STuple3</span> <span class="dt">SOpened</span> <span class="dt">SStopped</span> f) <span class="ot">=</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true"></a>      act <span class="dt">Close</span> s (<span class="dt">STuple3</span> <span class="dt">SClosed</span> <span class="dt">SStopped</span> f)</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true"></a>    action <span class="st">&quot;up&quot;</span> s<span class="op">@</span>(<span class="dt">STuple3</span> <span class="dt">SClosed</span> <span class="dt">SStopped</span> f) <span class="ot">=</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true"></a>      act (<span class="dt">Move</span> <span class="dt">SUp</span>) s (<span class="dt">STuple3</span> <span class="dt">SClosed</span> <span class="dt">SUp</span> (sNextFloor <span class="dt">SUp</span> f))</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true"></a>    action <span class="st">&quot;down&quot;</span> s<span class="op">@</span>(<span class="dt">STuple3</span> <span class="dt">SClosed</span> <span class="dt">SStopped</span> f) <span class="ot">=</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true"></a>      act (<span class="dt">Move</span> <span class="dt">SDown</span>) s</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true"></a>        (<span class="dt">STuple3</span> <span class="dt">SClosed</span> (sNextMoveState <span class="dt">SDown</span> f) (sNextFloor <span class="dt">SDown</span> f))</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true"></a>    action <span class="st">&quot;stop&quot;</span> s<span class="op">@</span>(<span class="dt">STuple3</span> <span class="dt">SClosed</span> _ f) <span class="ot">=</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true"></a>      act <span class="dt">Stop</span> s (<span class="dt">STuple3</span> <span class="dt">SClosed</span> <span class="dt">SStopped</span> f)</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true"></a>    action <span class="st">&quot;wait&quot;</span> s<span class="op">@</span>(<span class="dt">STuple3</span> d m f) <span class="ot">=</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true"></a>      act <span class="dt">Wait</span> s (<span class="dt">STuple3</span> d (sNextMoveState m f) (sNextFloor m f))</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true"></a>    action _ _ <span class="ot">=</span> <span class="dt">Nothing</span></span></code></pre></div>
<p>We need to specify both initial and final states of the action here, so at first it may seem that we can violate the type restrictions in the Action type and create disallowed action. But if any mistake is made in the function above that could lead to the creation of disallowed command, this function will not compile - try changing any of the state values above.</p>
<h2 id="lets-run-it">Let’s run it!</h2>
<p>We will let “the passengers” control the elevator, but if they try to perform the action that is not allowed it will be rejected.</p>
<p>To print the current elevator state we need a function to convert it to String, so it shows as, e.g., <code>(Opened,Stopped,0)</code>, and not as <code>SomeSing (STuple3 SOpened SStopped (SNat @0))</code>:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true"></a><span class="ot">show&#39; ::</span> <span class="dt">SomeSing</span> <span class="dt">Elevator</span> <span class="ot">-&gt;</span> <span class="dt">String</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true"></a>show&#39; (<span class="dt">SomeSing</span> s) <span class="ot">=</span> <span class="fu">show</span> (fromSing s)</span></code></pre></div>
<p>To create an interactive REPL that modifies and prints the elevator state in a loop we will use <a href="https://hackage.haskell.org/package/interact">interact</a> library<sup><a href="#interact">*</a></sup>:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true"></a>main <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true"></a>  <span class="kw">let</span> elevator <span class="ot">=</span> toSing (<span class="dt">Opened</span>, <span class="dt">Stopped</span>, <span class="dv">0</span>)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true"></a>  <span class="fu">putStrLn</span> <span class="st">&quot;Enter: open, close, up, down, wait or stop&quot;</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true"></a>  <span class="fu">putStrLn</span> <span class="op">$</span> show&#39; elevator</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true"></a>  replState runElevator elevator</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true"></a></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true"></a><span class="ot">runElevator ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">SomeSing</span> <span class="dt">Elevator</span> <span class="ot">-&gt;</span> (<span class="dt">String</span>, <span class="dt">SomeSing</span> <span class="dt">Elevator</span>)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true"></a>runElevator act st <span class="ot">=</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true"></a>  <span class="kw">case</span> actionFromString act st <span class="op">&gt;&gt;=</span> finalState st <span class="kw">of</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true"></a>    <span class="dt">Just</span> st&#39; <span class="ot">-&gt;</span> (show&#39; st&#39;, st&#39;)</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true"></a>    <span class="dt">Nothing</span> <span class="ot">-&gt;</span> (<span class="st">&quot;action &quot;</span> <span class="op">++</span> act <span class="op">++</span> <span class="st">&quot; not allowed&quot;</span>, st)</span></code></pre></div>
<p>The “elevator” now support actions “open”, “close”, “up”, “down”, “wait” and “stop” and prints its current state after each action.</p>
<p>You can run the code right from this post by cloning the <a href="https://github.com/epoberezkin/poberezkin.com">site repo</a> and executing <code>stack run elevator</code>. The source code without the text is available <a href="https://github.com/epoberezkin/elevator-state-machine">here</a>.</p>
<h2 id="problems">Problems</h2>
<p>You can try these problems with this elevator example (possible solutions are in the <a href="https://github.com/epoberezkin/elevator-state-machine/blob/master/src/Problems.hs">linked repo</a>):</p>
<ol type="1">
<li>Create an operation that chains “run-time” actions <code>SomeAction</code>:</li>
</ol>
<pre class="haskell-ignore"><code>(&gt;&gt;:) :: SomeAction -&gt; SomeAction -&gt; Maybe SomeAction</code></pre>
<ol start="2" type="1">
<li>Create a function that given initial state and a list of commands returns elevator “program” to perform this sequence of actions, if it is valid:</li>
</ol>
<pre class="haskell-ignore"><code>elevatorProgram :: SomeSing Elevator -&gt; [String] -&gt; Maybe SomeAction</code></pre>
<ol start="3" type="1">
<li>If you “close” the door on the ground floor and send the elevator “down”, it will remain <code>Stopped</code>, but the command will not be rejected. How to modify the type definition for <code>Action</code> to disallow it? If you do it, <code>actionFromString</code> will no longer compile - it has to be modified as well.</li>
<li>Create a function that given the current elevator state and the requested floor, returns an action sequence in <code>SomeAction</code> to send it to the specific floor, in case it is stopped and the door is opened, and <code>Nothing</code> otherwise:</li>
</ol>
<pre class="haskell-ignore"><code>elevatorToFloor :: SomeSing Elevator -&gt; Natural -&gt; Maybe SomeAction</code></pre>
<h2 id="whats-next">What’s next?</h2>
<p>You may have already asked some of the following questions:</p>
<ol type="1">
<li>How to define actions that return results?</li>
<li>How to define more complex state machines when the same action can change the state differently depending on the results of the previous actions?</li>
<li>Also, how to write interactive programs with these actions in a more conventional way using <code>do</code> notation?</li>
</ol>
<p>All these questions will be answered in Part 2.</p>
<p><a id="interact"><sup>*</sup> disclaimer - I created it</a></p>
  </section>
  <section class="links">
    <a href="https://www.reddit.com/r/haskell/comments/hkg9q8/modeling_state_machines_with_dependent_types_in/" target="_blank"><img src="/images/reddit.png"></a>
    <a href="https://twitter.com/intent/tweet?via=epoberezkin&text=Modeling%20state%20machines%20with%20dependent%20types%20in%20Haskell%3A%20Part%201&hashtags=haskell%2Cexecutable%2Ccoding&original_referer=https%3A%2F%2Fwww.poberezkin.com%2Fposts%2F2020-06-29-modeling-state-machine-dependent-types-haskell-1.html&url=https%3A%2F%2Fwww.poberezkin.com%2Fposts%2F2020-06-29-modeling-state-machine-dependent-types-haskell-1.html" target="_blank"><img src="/images/tweet.png"></a>
    
      <a href="https://github.com/epoberezkin/elevator-state-machine" target="_blank"><img src="/images/repo.png"></a>
    
  </section>
</article>
]]></summary>
</entry>
<entry>
    <title>Using dependent types in Haskell with singletons</title>
    <link href="https://www.poberezkin.com/posts/2020-05-17-using-dependent-types-haskell-singletons.html" />
    <id>https://www.poberezkin.com/posts/2020-05-17-using-dependent-types-haskell-singletons.html</id>
    <published>2020-05-17T00:00:00Z</published>
    <updated>2020-05-17T00:00:00Z</updated>
    <summary type="html"><![CDATA[<article>
  <section class="header">
    <div class="info">
      Posted on
      
        May 17, 2020
      
      
        by Evgeny Poberezkin
      
    </div>
    <div class="info">
      
        Tags: <a title="All pages tagged &#39;haskell&#39;." href="/tags/haskell.html">haskell</a>, <a title="All pages tagged &#39;coding&#39;." href="/tags/coding.html">coding</a>
      
    </div>
  </section>
  <section>
    <p>Haskell has a very advanced type system, but it does not yet have <a href="https://en.wikipedia.org/wiki/Dependent_type">dependent types</a>. Yet, singleton types and <a href="https://hackage.haskell.org/package/singletons">singletons library</a> provide a very good approximation of dependent types, that is shown on this diagram - the explanations to follow.</p>
<p><a href="https://github.com/epoberezkin/poberezkin.com/tree/master/dot/singletons1.gv"><img src="/images/singletons1.svg" title="source" alt="Singleton types" /></a></p>
<p>Justin Le wrote a fantastic <a href="https://blog.jle.im/entry/introduction-to-singletons-1.html">introduction to singletons library</a> and dependent type programming with Haskell - if you did not use singletons library before, I highly recommended reading it.</p>
<p>I’ve written this post to visualise the Haskell “problem” that prevents it from having dependent types, and the “solution” that singleton types offer.</p>
<h2 id="the-problem">The problem</h2>
<p>Haskell types can only have other types as their parameters, but not values. <a href="https://downloads.haskell.org/ghc/8.10.1/docs/html/users_guide/glasgow_exts.html#extension-DataKinds">DataKinds extension</a> automatically promotes all types to kinds and all constructors to types, in this way allowing other types depending on something that looks like values of another type. But there is no way to convert actual values to types, as promoted constructors are not connected to corresponding values and fully erased during compilation.</p>
<p>This is best illustrated with a simple example from Justin’s post. Suppose we have type <code>Door</code> parametrised with the types of the kind <code>DoorState</code>:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a><span class="kw">data</span> <span class="dt">DoorState</span> <span class="ot">=</span> <span class="dt">Opened</span> <span class="op">|</span> <span class="dt">Closed</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true"></a><span class="kw">data</span> <span class="dt">Door</span> (<span class="ot">a ::</span> <span class="dt">DoorState</span>)<span class="ot"> ::</span> <span class="dt">Type</span> <span class="kw">where</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true"></a>  <span class="dt">MkDoor</span><span class="ot"> ::</span> <span class="dt">Door</span> a</span></code></pre></div>
<p>These two declarations create kinds, types and values that are shown on diagram 2:</p>
<p><a href="https://github.com/epoberezkin/poberezkin.com/tree/master/dot/singletons2.gv"><img src="/images/singletons2.svg" title="source" alt="Types and kinds with DataKinds" /></a></p>
<p>The <code>DoorState</code> type is automatically promoted to <code>DoorState</code> kind, and <code>Opened</code>/<code>Closed</code> values belonging to type <code>DoorState</code> are automatically promoted to <code>'Opened</code>/<code>'Closed</code> types belonging to kind <code>DoorState</code> - these types have no values in them (other than <code>undefined</code>).</p>
<p>As you can see, the values <code>Opened</code>/<code>Closed</code> are not connected to the associated promoted constructors <code>'Opened</code>/<code>'Closed</code> - at the moment Haskell provides no way to connect them directly.</p>
<h2 id="the-solution">The solution</h2>
<p>Singleton types allow creating this missing link between ordinary values and their associated promoted constructors. The idea here is that for each value we need to create a separate type that has only one value in it. In this way, if we connect values in these singleton types to ordinary values (via polymorphic functions), and the singleton types themselves to the promoted constructors (via type inference), we will have managed to link types to values, even though indirectly - so we can use the equivalent of the dependent types in Haskell.</p>
<p>It does sound like a lot of boilerplate to write, but luckily singletons library automates the whole process by using Template Haskell to generate it. To illustrate using the same example as above, but with the singleton types added:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a><span class="op">$</span>(singletons [<span class="op">|</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true"></a>  <span class="kw">data</span> <span class="dt">DoorState</span> <span class="ot">=</span> <span class="dt">Opened</span> <span class="op">|</span> <span class="dt">Closed</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true"></a>  <span class="op">|</span>])</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true"></a><span class="kw">data</span> <span class="dt">Door</span> (<span class="ot">a ::</span> <span class="dt">DoorState</span>)<span class="ot"> ::</span> <span class="dt">Type</span> <span class="kw">where</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true"></a>  <span class="dt">MkDoor</span><span class="ot"> ::</span> <span class="dt">Sing</span> a <span class="ot">-&gt;</span> <span class="dt">Door</span> a</span></code></pre></div>
<p>The <code>singletons</code> splice adds two singleton types with the necessary framework, as shown on diagram 1 on top of the post.</p>
<p>Singleton types and values serve as an intermediary to link <code>Opened</code>/<code>Closed</code> values with <code>'Opened</code>/<code>'Closed</code> types that are used as parameters for the type <code>Door</code>, in this way making <code>Door</code> an equivalent of a dependent type.</p>
<h2 id="the-future">The future</h2>
<p>Using singleton types for dependent type programming in Haskell is a bit of a workaround, rather than a solution to the problem. It either requires an additional code to write or depends on singletons library templates to generate all the necessary code and on namespace conventions that users have to be aware of.</p>
<p>There is an ongoing work by <a href="https://richarde.dev/">Richard Eisenberg</a> to bring dependent types support to Haskell - it would be very exciting when it comes out.</p>
<p>Until then, we can use singletons library for type-driven development of complex systems, modelling their state transitions and all the relationships in “dependent” types.</p>
  </section>
  <section class="links">
    <a href="https://www.reddit.com/submit?url=https%3A%2F%2Fwww.poberezkin.com%2Fposts%2F2020-05-17-using-dependent-types-haskell-singletons.html&title=Using dependent types in Haskell with singletons" target="_blank"><img src="/images/reddit.png"></a>
    <a href="https://twitter.com/intent/tweet?via=epoberezkin&text=Using%20dependent%20types%20in%20Haskell%20with%20singletons&hashtags=haskell%2Ccoding&original_referer=https%3A%2F%2Fwww.poberezkin.com%2Fposts%2F2020-05-17-using-dependent-types-haskell-singletons.html&url=https%3A%2F%2Fwww.poberezkin.com%2Fposts%2F2020-05-17-using-dependent-types-haskell-singletons.html" target="_blank"><img src="/images/tweet.png"></a>
    
  </section>
</article>
]]></summary>
</entry>
<entry>
    <title>Why use advanced Haskell types?</title>
    <link href="https://www.poberezkin.com/posts/2020-04-29-why-use-advanced-haskell-types.html" />
    <id>https://www.poberezkin.com/posts/2020-04-29-why-use-advanced-haskell-types.html</id>
    <published>2020-04-29T00:00:00Z</published>
    <updated>2020-04-29T00:00:00Z</updated>
    <summary type="html"><![CDATA[<article>
  <section class="header">
    <div class="info">
      Posted on
      
        April 29, 2020
      
      
        by Evgeny Poberezkin
      
    </div>
    <div class="info">
      
        Tags: <a title="All pages tagged &#39;haskell&#39;." href="/tags/haskell.html">haskell</a>, <a title="All pages tagged &#39;coding&#39;." href="/tags/coding.html">coding</a>
      
    </div>
  </section>
  <section>
    <p>Haskell type system has dramatically evolved, both with the language extensions and libraries. It can be a challenge to navigate this space. So why anything beyond basic types is needed?</p>
<p>Types in Haskell provide a way not only to type-check the code you write, but to design the whole system in types, before any code is written, and then use the types to guide the development. It is worth reading the book “<a href="https://www.manning.com/books/type-driven-development-with-idris">Type-driven development in Idris</a>” by Edwin Brady about this approach.</p>
<p>Let’s try to design types for some service accounts that can represent a user or an organisation.</p>
<p>The source code is available in <a href="https://github.com/epoberezkin/advanced-haskell-types">advanced-haskell-types</a> repo.</p>
<h2 id="approach-1---basic-types">Approach #1 - basic types</h2>
<p>While users and organisations are quite different, they may have many similarities (for example, have a look at <a href="https://developer.github.com/v3/users/#get-a-single-user">GitHub API</a> that returns both users and orgs).</p>
<p>Our users and orgs share some functionality and we would want to store them in one list. So we will make a single type to hold these accounts:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a><span class="co">-- shared information for both users and organisations</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true"></a><span class="kw">data</span> <span class="dt">AInfo</span> <span class="ot">=</span> <span class="dt">AInfo</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true"></a>              {<span class="ot"> name ::</span> <span class="dt">Text</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true"></a>              ,<span class="ot"> displayName ::</span> <span class="dt">Text</span> }</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true"></a><span class="kw">data</span> <span class="dt">Account</span> <span class="ot">=</span> <span class="dt">User</span> <span class="dt">AInfo</span> <span class="op">|</span> <span class="dt">Org</span> <span class="dt">AInfo</span> <span class="dt">Members</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true"></a><span class="kw">type</span> <span class="dt">Members</span> <span class="ot">=</span> [<span class="dt">Account</span>]</span></code></pre></div>
<p>We’ve already met the first problem with this approach - members of the organisation should be users, but <code>Members</code> type allows both users and organisations - we will have to manage it in code.</p>
<p>Here are some functions for these accounts:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a><span class="co">-- all shared functions should work with both users and orgs</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true"></a><span class="ot">accountName ::</span> <span class="dt">Account</span> <span class="ot">-&gt;</span> <span class="dt">Text</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true"></a>accountName (<span class="dt">User</span> info) <span class="ot">=</span> name info</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true"></a>accountName (<span class="dt">Org</span> info _) <span class="ot">=</span> name info</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true"></a><span class="co">-- but some functions may only work with orgs,</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true"></a><span class="co">-- so we will have to use Maybe type to return results</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true"></a><span class="ot">orgMembers ::</span> <span class="dt">Account</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Members</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true"></a>orgMembers (<span class="dt">User</span> _) <span class="ot">=</span> <span class="dt">Nothing</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true"></a>orgMembers (<span class="dt">Org</span> _ ms) <span class="ot">=</span> <span class="dt">Just</span> ms</span></code></pre></div>
<p>It’s easy to put accounts in one list and process this list, as they have the same type, but we will have to check the result when we use a function intended only for organisations:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true"></a>main <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true"></a>  <span class="kw">let</span> user <span class="ot">=</span> <span class="dt">User</span> (<span class="dt">AInfo</span> <span class="st">&quot;john&quot;</span> <span class="st">&quot;John Doe&quot;</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true"></a>      org <span class="ot">=</span> <span class="dt">Org</span> (<span class="dt">AInfo</span> <span class="st">&quot;team&quot;</span> <span class="st">&quot;John&#39;s team&quot;</span>) [user]</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true"></a>      accounts <span class="ot">=</span> [user, org]</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true"></a>  <span class="fu">print</span> <span class="op">$</span> <span class="fu">map</span> accountName accounts</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true"></a>  <span class="kw">case</span> orgMembers org <span class="kw">of</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true"></a>    <span class="dt">Just</span> ms <span class="ot">-&gt;</span> <span class="fu">print</span> <span class="op">$</span> <span class="fu">map</span> accountName ms</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true"></a>    <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="fu">return</span> ()</span></code></pre></div>
<p>Could we design better types for our scenario to avoid the need to check the result of functions for orgs? It would also be good to prevent organisations being added as members at a type level, but without losing the ability to process both users and organisation in a single list.</p>
<h2 id="approach-2---existential-quantification">Approach #2 - existential quantification</h2>
<p>Let’s try to create two different types to store users and organisations, to avoid the problems we had:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true"></a><span class="kw">data</span> <span class="dt">User</span> <span class="ot">=</span> <span class="dt">User</span> <span class="dt">AInfo</span> <span class="co">-- we could have made it newtype</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true"></a><span class="kw">data</span> <span class="dt">Org</span> <span class="ot">=</span> <span class="dt">Org</span> <span class="dt">AInfo</span> <span class="dt">Members</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true"></a><span class="kw">type</span> <span class="dt">Members</span> <span class="ot">=</span> [<span class="dt">User</span>]</span></code></pre></div>
<p>This is better, organisation members can be only users now.</p>
<p>We cannot have one function working on two different types, but we can define a type class and make <code>User</code> and <code>Org</code> types its instances:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true"></a><span class="kw">class</span> <span class="dt">Acc</span> a <span class="kw">where</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true"></a><span class="ot">  accountName ::</span> a <span class="ot">-&gt;</span> <span class="dt">Text</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true"></a><span class="kw">instance</span> <span class="dt">Acc</span> <span class="dt">User</span> <span class="kw">where</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true"></a>  accountName (<span class="dt">User</span> info) <span class="ot">=</span> name info</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true"></a><span class="kw">instance</span> <span class="dt">Acc</span> <span class="dt">Org</span> <span class="kw">where</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true"></a>  accountName (<span class="dt">Org</span> info _) <span class="ot">=</span> name info</span></code></pre></div>
<p>And we can also have a function that works only with organisations, without using Maybe:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true"></a><span class="ot">orgMembers ::</span> <span class="dt">Org</span> <span class="ot">-&gt;</span> <span class="dt">Members</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true"></a>orgMembers (<span class="dt">Org</span> _ ms) <span class="ot">=</span> ms</span></code></pre></div>
<p>The problem that we now have is that <code>User</code> and <code>Org</code> are two different types, and we cannot put them into one list.</p>
<p>Haskell GHC compiler (since v6.8.1 released in 2007) has the extension <a href="https://downloads.haskell.org/ghc/8.8.3/docs/html/users_guide/glasgow_exts.html#extension-ExistentialQuantification">ExistentialQuantification</a> that allows to create a type that can wrap values of multiple types, and the members of this wrapper type can be put in the list:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true"></a><span class="kw">data</span> <span class="dt">A</span> <span class="ot">=</span> <span class="kw">forall</span> a<span class="op">.</span> <span class="dt">Acc</span> a <span class="ot">=&gt;</span> <span class="dt">A</span> a</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true"></a><span class="kw">type</span> <span class="dt">Accounts</span> <span class="ot">=</span> [<span class="dt">A</span>]</span></code></pre></div>
<p>In our case we limit the allowed types to the instances of <code>Acc</code> type class, so we can use the list elements with our type class functions, but it is not the only shared criteria the types can have and still be useful - see another example in ExistentialQuantification docs.</p>
<p>Now we can put wrapped users and orgs into the same list and process them:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true"></a>main <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true"></a>  <span class="kw">let</span> user <span class="ot">=</span> <span class="dt">User</span> (<span class="dt">AInfo</span> <span class="st">&quot;john&quot;</span> <span class="st">&quot;John Doe&quot;</span>)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true"></a>      org <span class="ot">=</span> <span class="dt">Org</span> (<span class="dt">AInfo</span> <span class="st">&quot;team&quot;</span> <span class="st">&quot;John&#39;s team&quot;</span>) [user]</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true"></a>      accounts <span class="ot">=</span> [<span class="dt">A</span> user, <span class="dt">A</span> org] <span class="co">-- we need to wrap users and orgs</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true"></a>  <span class="co">-- we do not need to check type of the org now</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true"></a>  <span class="fu">print</span> <span class="op">.</span> <span class="fu">map</span> accountName <span class="op">$</span> orgMembers org</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true"></a></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true"></a>  <span class="co">-- the only way to unwrap an existential wrapper is with pattern matching</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true"></a>  <span class="fu">print</span> <span class="op">$</span> <span class="fu">map</span> (\(<span class="dt">A</span> acc) <span class="ot">-&gt;</span> accountName acc) accounts</span></code></pre></div>
<p>There are two downsides of this approach:</p>
<ol type="1">
<li>We cannot limit which types can be instances of <code>Acc</code> type class. While in some more general cases this unlimited extensibility can be helpful, if we want to control which types can be used as <code>Acc</code> we need some other approach.</li>
<li>We have to write some boiler plate code - we really just wanted one type with some additional flexibility in it, and not two different types and type class to represent it.</li>
</ol>
<p>Let’s try to solve these problems.</p>
<h2>
Approach #3 - data families and data kinds
</h2>
<p>We will try to limit the types that can be instances of <code>Acc</code> type class. Types in Haskell have kinds, and in most cases the kind of a type is determined by the number of type parameters.</p>
<p>From v7.4.1 released in 2012 Haskell makes all your types also kinds using <a href="https://downloads.haskell.org/ghc/8.8.3/docs/html/users_guide/glasgow_exts.html#extension-DataKinds">DataKinds</a> extension - we will use it to limit the types that can be used as <code>Acc</code>. We will also use extensions <a href="https://downloads.haskell.org/ghc/8.8.3/docs/html/users_guide/glasgow_exts.html#extension-TypeFamilies">TypeFamilies</a> and ExistentialQuantification we already used to have types of user and organisation related to each other and to put them into the same list.</p>
<p>Let’s define a simple type that has the list of allowed account types:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true"></a><span class="kw">data</span> <span class="dt">AType</span> <span class="ot">=</span> <span class="dt">AUser</span> <span class="op">|</span> <span class="dt">AOrg</span></span></code></pre></div>
<p>With DataKinds extension each <em>type</em> (in this case <code>AType</code>) automatically becomes a <em>kind</em> that can be used to define and restrict other types. We will use this kind to create <code>Account</code> data family:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true"></a><span class="kw">data</span> <span class="kw">family</span> <span class="dt">Account</span> (<span class="ot">a ::</span> <span class="dt">AType</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true"></a><span class="kw">data</span> <span class="kw">instance</span> <span class="dt">Account</span> <span class="dt">&#39;AUser</span> <span class="ot">=</span> <span class="dt">User</span> <span class="dt">AInfo</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true"></a><span class="kw">data</span> <span class="kw">instance</span> <span class="dt">Account</span> <span class="dt">&#39;AOrg</span> <span class="ot">=</span> <span class="dt">Org</span> <span class="dt">AInfo</span> <span class="dt">Members</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true"></a><span class="kw">type</span> <span class="dt">Members</span> <span class="ot">=</span> [<span class="dt">Account</span> <span class="dt">&#39;AUser</span>] <span class="co">-- organisation members can be only users</span></span></code></pre></div>
<p><code>'AUser</code> and <code>'AOrg</code> is a special syntax that allows to use <em>constructors of type</em> <code>AType</code> as <em>types of kind</em> <code>AType</code>. <code>User</code> and <code>Org</code> are just normal constructors of types <code>Account 'AUser</code> and <code>Account 'AOrg</code>.</p>
<p>To define shared functionality we would still have to use a type class, because while <code>Account 'AUser</code> and <code>Account 'AOrg</code> are now related (as family members), they are still two separate types:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true"></a><span class="kw">class</span> <span class="dt">Acc</span> (<span class="ot">a ::</span> <span class="dt">AType</span>) <span class="kw">where</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true"></a><span class="ot">  accountName ::</span> <span class="dt">Account</span> a <span class="ot">-&gt;</span> <span class="dt">Text</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true"></a><span class="kw">instance</span> <span class="dt">Acc</span> <span class="dt">AUser</span> <span class="kw">where</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true"></a>  accountName (<span class="dt">User</span> info) <span class="ot">=</span> name info</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true"></a><span class="kw">instance</span> <span class="dt">Acc</span> <span class="dt">AOrg</span> <span class="kw">where</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true"></a>  accountName (<span class="dt">Org</span> info _) <span class="ot">=</span> name info</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true"></a><span class="ot">orgMembers ::</span> <span class="dt">Account</span> <span class="dt">&#39;AOrg</span> <span class="ot">-&gt;</span> <span class="dt">Members</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true"></a>orgMembers (<span class="dt">Org</span> _ ms) <span class="ot">=</span> ms</span></code></pre></div>
<p>Please note that in this case we made types belonging to our custom-made kind <code>AType</code> instances of type-class <code>Acc</code>, rather than account types. We can neither extend data family <code>Account a</code> nor type class <code>Acc</code> without extending our kind <code>AType</code>.</p>
<p>We still need to create an existential wrapper type to put users and orgs in the same list:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true"></a><span class="kw">data</span> <span class="dt">A</span> <span class="ot">=</span> <span class="kw">forall</span> a<span class="op">.</span> <span class="dt">Acc</span> a <span class="ot">=&gt;</span> <span class="dt">A</span> (<span class="dt">Account</span> a)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true"></a><span class="kw">type</span> <span class="dt">Accounts</span> <span class="ot">=</span> [<span class="dt">A</span>]</span></code></pre></div>
<p>We can use exactly the same code to process users and orgs as in approach #2.</p>
<p>We have managed to restrict the types of accounts by defining a kind, but do we really need 2 different types and a type-class, or is there a way to create just one, a more advanced type?</p>
<h2 id="approach-4---gadts">Approach #4 - GADTs</h2>
<p>We can achieve the same flexibility using a generalised algebraic data type - support for such types is enabled with <a href="https://downloads.haskell.org/ghc/8.8.3/docs/html/users_guide/glasgow_exts.html#extension-GADTs">GADTs</a> extension.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true"></a><span class="kw">data</span> <span class="dt">AType</span> <span class="ot">=</span> <span class="dt">AUser</span> <span class="op">|</span> <span class="dt">AOrg</span> <span class="co">-- we still need DataKinds extension</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true"></a><span class="co">-- (a :: AType) here requires KindSignatures extension</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true"></a><span class="kw">data</span> <span class="dt">Account</span> (<span class="ot">a ::</span> <span class="dt">AType</span>) <span class="kw">where</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true"></a>  <span class="dt">User</span><span class="ot"> ::</span> <span class="dt">AInfo</span> <span class="ot">-&gt;</span> <span class="dt">Account</span> <span class="dt">&#39;AUser</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true"></a>  <span class="dt">Org</span><span class="ot"> ::</span> <span class="dt">AInfo</span> <span class="ot">-&gt;</span> <span class="dt">Members</span> <span class="ot">-&gt;</span> <span class="dt">Account</span> <span class="dt">&#39;AOrg</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true"></a></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true"></a><span class="kw">type</span> <span class="dt">Members</span> <span class="ot">=</span> [<span class="dt">Account</span> <span class="dt">&#39;AUser</span>] <span class="co">-- organisation members can be only users</span></span></code></pre></div>
<p>Now that we have one parametrised type, we can define functions on this general type without a type class, using just pattern matching:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true"></a><span class="ot">accountName ::</span> <span class="dt">Account</span> a <span class="ot">-&gt;</span> <span class="dt">Text</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true"></a>accountName (<span class="dt">User</span> info) <span class="ot">=</span> name info</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true"></a>accountName (<span class="dt">Org</span> info _) <span class="ot">=</span> name info</span></code></pre></div>
<p>We can also define functions on specific types:</p>
<pre><code>orgMembers :: Account &#39;AOrg -&gt; Members
orgMembers (Org _ ms) = ms</code></pre>
<p>We still need an existential wrapper to put a general type in a list, but it is a bit simpler now, as we do not need a type class:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true"></a><span class="kw">data</span> <span class="dt">A</span> <span class="ot">=</span> <span class="kw">forall</span> a<span class="op">.</span> <span class="dt">A</span> (<span class="dt">Account</span> a)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true"></a><span class="kw">type</span> <span class="dt">Accounts</span> <span class="ot">=</span> [<span class="dt">A</span>]</span></code></pre></div>
<p>GADTs extension implies ExistentialQuantification, so we do not need to enable it separately.</p>
<p>The same code as above can be used to process the list of users and orgs.</p>
<h2 id="summary">Summary</h2>
<p>Beyond basic types, we looked at three options that allow to define different entities with shared behaviours and to manage them in the same data structure:</p>
<ol type="1">
<li>Type classes - the most extensible option, that allows to define the behaviour independently of its implementation. The classic scenario for type classes is some kind of widgets/shapes/etc.</li>
<li>Data families restricted with data kinds. The advantage of such data families is that you can define its members in different parts of your code, but you have control of the list of allowed members in a single location using a custom data kind.</li>
<li>GADTs - they provide a much bigger flexibility in defining your types, in many cases without the need for type classes. They allow different constructors of one parametrised type (of a higher kind) to return specific types (of basic kind).</li>
</ol>
<p>Haskell offers many different approaches to design your whole system, not just its data, in types. This post is just a small sample of what is possible with advanced Haskell types.</p>
  </section>
  <section class="links">
    <a href="https://www.reddit.com/submit?url=https%3A%2F%2Fwww.poberezkin.com%2Fposts%2F2020-04-29-why-use-advanced-haskell-types.html&title=Why use advanced Haskell types?" target="_blank"><img src="/images/reddit.png"></a>
    <a href="https://twitter.com/intent/tweet?via=epoberezkin&text=Why%20use%20advanced%20Haskell%20types%3F&hashtags=haskell%2Ccoding&original_referer=https%3A%2F%2Fwww.poberezkin.com%2Fposts%2F2020-04-29-why-use-advanced-haskell-types.html&url=https%3A%2F%2Fwww.poberezkin.com%2Fposts%2F2020-04-29-why-use-advanced-haskell-types.html" target="_blank"><img src="/images/tweet.png"></a>
    
      <a href="https://github.com/epoberezkin/advanced-haskell-types" target="_blank"><img src="/images/repo.png"></a>
    
  </section>
</article>
]]></summary>
</entry>
<entry>
    <title>Haskell — a higher order language</title>
    <link href="https://www.poberezkin.com/posts/2020-03-15-haskell-a-higher-order-language.html" />
    <id>https://www.poberezkin.com/posts/2020-03-15-haskell-a-higher-order-language.html</id>
    <published>2020-03-15T00:00:00Z</published>
    <updated>2020-03-15T00:00:00Z</updated>
    <summary type="html"><![CDATA[<article>
  <section class="header">
    <div class="info">
      Posted on
      
        <a href="https://medium.com/@epoberezkin/haskell-a-higher-order-language-ade461d453c7">March 15, 2020</a>
      
      
        by Evgeny Poberezkin
      
    </div>
    <div class="info">
      
        Tags: <a title="All pages tagged &#39;haskell&#39;." href="/tags/haskell.html">haskell</a>, <a title="All pages tagged &#39;executable&#39;." href="/tags/executable.html">executable</a>, <a title="All pages tagged &#39;coding&#39;." href="/tags/coding.html">coding</a>
      
    </div>
  </section>
  <section>
    <p><img src="/images/haskell.png" width="40%" style="float: left; margin: 20px 20px 10px 0;" /></p>
<p>The thesis here is that Haskell is not just one of many functional programming languages — it is a different, more advanced programming paradigm.</p>
<p>Haskell is indeed a functional language, but calling Haskell “a functional language” is like calling a skyscraper “a dwelling” — while technically correct, it does not describe how the latter is much more than just a place to live.</p>
<p>What defines a programming language? From the point of view of category theory, there are two major components of each programming language: data types and transformations between them — in category theory terminology, “objects” and “morphisms”.</p>
<p><strong>The first claim</strong> here (that must be challenged) is that all programming languages but Haskell (and more recent Idris) are based on “morphisms” — code, procedures or functions that transform and manipulate the data. Data types in these languages play the secondary role — to ensure validity and to improve predictability of the “morphisms”.</p>
<p>Haskell, being a functional language, counterintuitively, is not based on functions — it is based on types, or “objects” in category theory terminology. Types ensuring the validity of transformations almost seems secondary in Haskell (however useful), while the primary purpose of types is to formally describe the system model and the relationship between the elements of the system (including functions that also have types).</p>
<p>But a bigger distinction between Haskell and other languages is in the nature of the language semantics. <strong>The second claim</strong> (that also must be challenged) is that while other languages have semantics tightly coupled with the syntax — the meaning of the code is defined by its grammar, Haskell semantics is defined by the combination of code and context (e.g., created by the types that belong to Monad class). In this way, Haskell is much closer than other programming languages to the natural human languages that also have semantics defined by the combination of grammar and context (see interpretive and generative semantics of human languages).</p>
<p>For example, a simple <code>sequence</code> function that is defined as:</p>
<pre class="haskell-ignore"><code>sequence :: Monad m =&gt; [m a] -&gt; m [a]
sequence ms = foldr k (return []) ms
            where
              k m m&#39; = do { x &lt;- m; xs &lt;- m&#39;; return (x:xs) }</code></pre>
<p>can mean different things depending on the context that is defined by <code>m</code>.</p>
<p>Applied to IO it can mean performing IO actions in sequence:</p>
<pre class="haskell-ignore"><code>sequence [getLine, getLine]</code></pre>
<p>returns a single IO action that resolves into the list of 2 strings.</p>
<p>Applied to the list of instances of <code>Maybe</code> type, it would check that all of them contain some value and either return <code>Just</code> list of these value or Nothing if any of them is <code>Nothing</code>:</p>
<pre class="haskell-ignore"><code>sequence [Just 1, Just 2, Just 3] = Just [1, 2, 3]
sequence [Just 1, Just 2, Nothing] = Nothing</code></pre>
<p>Applied to the list of 2 lists, it will perform indeterminate computation and return all possible permutations of list items where the first item comes from the first list, and the second — from the second list:</p>
<pre class="haskell-ignore"><code>sequence [[1,2],[3,4]] = [[1,3],[1,4],[2,3],[2,4]]
sequence [[1,2],[3,4], []] = [] -- [] is &quot;undefined&quot; in this context</code></pre>
<p>Context-dependent semantics of Haskell code makes Haskell more difficult to learn. As the same syntax can mean many different things, achieving fluency requires more effort than with other languages. But it also makes Haskell infinitely more expressive than any other language — you can implement any new semantics you want by adding the new context to the same code. Therefore, while Haskell requires more investment from you than other programming languages, the return on this investment is infinitely higher.</p>
<p>Some Haskell books (e.g. <a href="http://learnyouahaskell.com/">LYAH</a>) and lectures (e.g <a href="https://www.seas.upenn.edu/~cis194/fall16/index.html">Penn course</a>) do not capture this fundamental distinction well enough. Instead, they focus on the functional nature of Haskell, and present Monad as almost some work-around to allow using pure functions for context-aware computations (IO, State, indeterminism, etc.). Unfortunately, it creates a barrier to entry for the new developers, because when people are asked to make a larger than usual investment to learn yet one more functional programming language with quirky syntax, this investment is difficult to justify without understanding first that Haskell is a more powerful programming paradigm. How many people abandoned Haskell before grasping its power?</p>
<p>A good book that explains how Haskell is a higher order language is <a href="https://en.wikibooks.org/wiki/Haskell">Haskell</a> in wiki-books. Once you get over “<a href="https://en.wikibooks.org/wiki/Haskell/Understanding_monads">Understanding monads</a>” section, the Haskell advantage should become apparent.</p>
<p>If you want to see some relatively simple magic you can do with Haskell, watch the talk by <a href="https://github.com/EncodePanda">Paweł Szulc</a> at Lambda World’19, particularly where he <a href="https://www.youtube.com/watch?v=idU7GdlfP9Q&amp;feature=youtu.be&amp;t=625">talks about Servant</a> — the library to create REST APIs in Haskell. Before you write a single line of implementation code, you can get the whole API definition from a single type definition (I am replacing alpacas from Paweł’s farm with users here):</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true"></a><span class="ot">{-# LANGUAGE DataKinds, DeriveAnyClass, DeriveGeneric, TypeOperators #-}</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true"></a><span class="kw">import</span> <span class="dt">Servant</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true"></a><span class="kw">import</span> <span class="dt">Servant.Server</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true"></a><span class="kw">import</span> <span class="dt">Network.Wai.Handler.Warp</span> (run)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true"></a><span class="kw">import</span> <span class="dt">Data.Aeson</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true"></a><span class="kw">import</span> <span class="dt">GHC.Generics</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Map</span> <span class="kw">as</span> <span class="dt">M</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true"></a><span class="kw">data</span> <span class="dt">User</span> <span class="ot">=</span> <span class="dt">User</span> {</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true"></a><span class="ot">  name  ::</span> <span class="dt">String</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true"></a>} <span class="kw">deriving</span> (<span class="dt">Generic</span>, <span class="dt">ToJSON</span>, <span class="dt">FromJSON</span>)</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true"></a></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true"></a><span class="kw">type</span> <span class="dt">UserAPI</span> <span class="ot">=</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true"></a>       <span class="st">&quot;user&quot;</span> <span class="op">:&gt;</span> <span class="dt">Get</span> &#39;[<span class="dt">JSON</span>] (<span class="dt">M.Map</span> <span class="dt">Int</span> <span class="dt">User</span>)</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true"></a>  <span class="op">:&lt;|&gt;</span> <span class="st">&quot;user&quot;</span> <span class="op">:&gt;</span> <span class="dt">Capture</span> <span class="st">&quot;userId&quot;</span> <span class="dt">Int</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true"></a>              <span class="op">:&gt;</span> <span class="dt">Get</span> &#39;[<span class="dt">JSON</span>] <span class="dt">User</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true"></a>  <span class="op">:&lt;|&gt;</span> <span class="st">&quot;user&quot;</span> <span class="op">:&gt;</span> <span class="dt">Capture</span> <span class="st">&quot;userId&quot;</span> <span class="dt">Int</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true"></a>              <span class="op">:&gt;</span> <span class="dt">ReqBody</span> &#39;[<span class="dt">JSON</span>] <span class="dt">User</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true"></a>              <span class="op">:&gt;</span> <span class="dt">PutCreated</span> &#39;[<span class="dt">JSON</span>] <span class="dt">NoContent</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true"></a></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true"></a><span class="ot">userApi ::</span> <span class="dt">Proxy</span> <span class="dt">UserAPI</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true"></a>userApi <span class="ot">=</span> <span class="dt">Proxy</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true"></a></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true"></a><span class="co">-- UserAPI type defines this API:</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true"></a><span class="co">-- GET /user   - Response: {&quot;1&quot;:{&quot;name&quot;:&quot;jane&quot;}}, 200</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true"></a><span class="co">-- GET /user/1 - Response: {&quot;name&quot;:&quot;jane&quot;}, 200</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true"></a><span class="co">-- PUT /user/2 Body: {&quot;name&quot;:&quot;John D.&quot;} - Response: NoContent, 201</span></span></code></pre></div>
<p>And before you even start implementing this API you can get client functions to call this API with a few lines of code:</p>
<pre class="haskell-ignore"><code>-- import Servant.Client

getAll :&lt;|&gt; getUser :&lt;|&gt; putUser = client userApi

-- client functions types:
getAll :: ClientM (M.Map Int User)
getUser :: Int -&gt; ClientM User
putUser :: Int -&gt; User -&gt; ClientM User</code></pre>
<p>With just a few annotations you can generate API docs from UserAPI type:</p>
<pre class="haskell-ignore"><code>instance ToCapture (Capture &quot;userId&quot; Int) where
  toCapture _ =
    DocCapture &quot;userId&quot;
               &quot;Id that uniquely identifies a user in the system&quot;

instance ToSample (User) where
  toSamples _ = singleSample $ User &quot;Jane&quot;

instance ToSample (M.Map Int User) where
  toSamples _ = singleSample $ M.singleton 1 (User &quot;Jane&quot;)

apiDocs :: API
apiDocs = docs userApi

main :: IO ()
main = (writeFile &quot;docs.md&quot; . markdown) apiDocs</code></pre>
<p>To run this server you just need to implement it, the mock implementation is very simple, but the Haskell type system ensures that the type of implementation is correct (<code>Server UserAPI</code> that is based on <code>UserAPI</code> type):</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true"></a>dummy <span class="ot">=</span> <span class="dt">User</span> <span class="st">&quot;Jane&quot;</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true"></a><span class="ot">fetchAll ::</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> m (<span class="dt">M.Map</span> <span class="dt">Int</span> <span class="dt">User</span>)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true"></a>fetchAll <span class="ot">=</span> <span class="fu">pure</span> <span class="op">$</span> M.singleton <span class="dv">1</span> dummy</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true"></a><span class="ot">fetch ::</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> m <span class="dt">User</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true"></a>fetch <span class="fu">id</span> <span class="ot">=</span> <span class="fu">pure</span> dummy</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true"></a><span class="ot">insert ::</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">User</span> <span class="ot">-&gt;</span> m <span class="dt">NoContent</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true"></a>insert <span class="fu">id</span> user <span class="ot">=</span> <span class="fu">pure</span> <span class="dt">NoContent</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true"></a></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true"></a><span class="ot">server ::</span> <span class="dt">Server</span> <span class="dt">UserAPI</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true"></a>server <span class="ot">=</span> fetchAll <span class="op">:&lt;|&gt;</span> fetch <span class="op">:&lt;|&gt;</span> insert</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true"></a></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true"></a><span class="ot">app ::</span> <span class="dt">Application</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true"></a>app <span class="ot">=</span> serve userApi server</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true"></a></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true"></a>main <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true"></a>  <span class="fu">putStrLn</span> <span class="st">&quot;http://localhost:8080/user&quot;</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true"></a>  run <span class="dv">8080</span> app</span></code></pre></div>
<p>The above does feel like magic! You can run this server right from this post with <code>stack run users-api</code>.</p>
<p>Morphism-based programming languages (i.e., all other languages) force programmers to model the whole system outside of the code — using SQL schema, JSON schema, diagrams, etc. Type-based languages (Haskell and Idris) allow for type-driven development, when the whole system can be modelled top-down with algebraic data types, rather than bottom-up with functions as in other languages.</p>
<p>Haskell being type-based language with context-dependent semantics is a higher order language that is almost one of a kind — there seems to be no other mature programming language that allows the same level of expressiveness as Haskell does.</p>
  </section>
  <section class="links">
    <a href="https://www.reddit.com/submit?url=https%3A%2F%2Fwww.poberezkin.com%2Fposts%2F2020-03-15-haskell-a-higher-order-language.html&title=Haskell — a higher order language" target="_blank"><img src="/images/reddit.png"></a>
    <a href="https://twitter.com/intent/tweet?via=epoberezkin&text=Haskell%20%E2%80%94%20a%20higher%20order%20language&hashtags=haskell%2Cexecutable%2Ccoding&original_referer=https%3A%2F%2Fwww.poberezkin.com%2Fposts%2F2020-03-15-haskell-a-higher-order-language.html&url=https%3A%2F%2Fwww.poberezkin.com%2Fposts%2F2020-03-15-haskell-a-higher-order-language.html" target="_blank"><img src="/images/tweet.png"></a>
    
  </section>
</article>
]]></summary>
</entry>
<entry>
    <title>Why you should Open-Source for Real</title>
    <link href="https://www.poberezkin.com/posts/2019-07-10-talk-why-you-should-open-source-for-real.html" />
    <id>https://www.poberezkin.com/posts/2019-07-10-talk-why-you-should-open-source-for-real.html</id>
    <published>2019-07-10T00:00:00Z</published>
    <updated>2019-07-10T00:00:00Z</updated>
    <summary type="html"><![CDATA[<article>
  <section class="header">
    <div class="info">
      Posted on
      
        <a href="https://skillsmatter.com/skillscasts/14213-lightning-talk-coding-you-either-love-or-hate-it-or-why-you-should-open-source-for-real">July 10, 2019</a>
      
      
        by Evgeny Poberezkin
      
    </div>
    <div class="info">
      
        Tags: <a title="All pages tagged &#39;talk&#39;." href="/tags/talk.html">talk</a>, <a title="All pages tagged &#39;coding&#39;." href="/tags/coding.html">coding</a>, <a title="All pages tagged &#39;open-source&#39;." href="/tags/open-source.html">open-source</a>
      
    </div>
  </section>
  <section>
    <p>This is a <a href="https://skillsmatter.com/skillscasts/14213-lightning-talk-coding-you-either-love-or-hate-it-or-why-you-should-open-source-for-real">talk at FullStack London 2019</a>.</p>
<p><a href="https://skillsmatter.com/skillscasts/14213-lightning-talk-coding-you-either-love-or-hate-it-or-why-you-should-open-source-for-real"> <img src="/images/talk2019.jpg" alt="Why You Should Open-Source For Real" width="100%"> </a></p>
<blockquote>
<p>Coding is hard but you still love it. But you also hate it, at least on some days.</p>
</blockquote>
<blockquote>
<p>Humans are unpredictable so you chose to work with code and computers. But code outcomes are becoming increasingly unpredictable, and to succeed in coding you need to succeed with other humans.</p>
</blockquote>
<blockquote>
<p>Open-source contribution is a complete waste of time. But it is also the best investment of time you can make to become a better engineer and it will also make you a better human being (maybe).</p>
</blockquote>
  </section>
  <section class="links">
    <a href="https://www.reddit.com/submit?url=https%3A%2F%2Fwww.poberezkin.com%2Fposts%2F2019-07-10-talk-why-you-should-open-source-for-real.html&title=Why you should Open-Source for Real" target="_blank"><img src="/images/reddit.png"></a>
    <a href="https://twitter.com/intent/tweet?via=epoberezkin&text=Why%20you%20should%20Open-Source%20for%20Real&hashtags=talk%2Ccoding%2Copen-source&original_referer=https%3A%2F%2Fwww.poberezkin.com%2Fposts%2F2019-07-10-talk-why-you-should-open-source-for-real.html&url=https%3A%2F%2Fwww.poberezkin.com%2Fposts%2F2019-07-10-talk-why-you-should-open-source-for-real.html" target="_blank"><img src="/images/tweet.png"></a>
    
  </section>
</article>
]]></summary>
</entry>
<entry>
    <title>Locked in the Narrative?</title>
    <link href="https://www.poberezkin.com/posts/2019-05-31-locked-in-the-narrative.html" />
    <id>https://www.poberezkin.com/posts/2019-05-31-locked-in-the-narrative.html</id>
    <published>2019-05-31T00:00:00Z</published>
    <updated>2019-05-31T00:00:00Z</updated>
    <summary type="html"><![CDATA[<article>
  <section class="header">
    <div class="info">
      Posted on
      
        <a href="https://medium.com/@epoberezkin/locked-in-the-narrative-921bc45006dd">May 31, 2019</a>
      
      
        by Evgeny Poberezkin
      
    </div>
    <div class="info">
      
        Tags: <a title="All pages tagged &#39;essay&#39;." href="/tags/essay.html">essay</a>
      
    </div>
  </section>
  <section>
    <p>When we are children, we choose the stories of our future lives. “I will be a cosmonaut.” Or “I will be a doctor”. Our stories are supported by parents — toys fuel our fantasies until they burn out and we move on.</p>
<p>For most of us these stories change many times as we grow up. Few stay fixated on the story to live it, fewer turn out to be happy when they do.</p>
<p>As we become older we continue choosing such stories. “I want to be a manager.” Or “I want to create tools for other engineers.” Or “The people have voted, we must respect it.”</p>
<p>Led by these stories, we often get from being unhappy to being miserable. And the cycle repeats again — we choose a new story to believe in.</p>
<p>We complain about lacking freedom, but the strongest prison is the one we put ourselves in without knowing it exists. We are pressured to make choices all our life. “Will you have tea or coffee?” “What college did you apply to?” “What is your next career step?” “How have you invested your money?”</p>
<p>Making these decisions is important, but when they are not rooted in the reality of who we are and instead based on the stories we chose to believe, we can’t be happy. The best decision you can make, is to not make the decision until it is your own and not led by your current story. But resisting the urge to make the decision is hard — it takes growing up.</p>
<p>To be free we need to remember that most of our ideas about the world and about ourselves are just stories re-told by other people. Very rarely we hear an original story, and when we do, we often just ignore it.</p>
<p>We can discover our own truths about who we are, what we want and to write the story of our life ourselves. Until then, we can follow the opportunities and keep our options open — the story of our life may just write itself.</p>
  </section>
  <section class="links">
    <a href="https://www.reddit.com/submit?url=https%3A%2F%2Fwww.poberezkin.com%2Fposts%2F2019-05-31-locked-in-the-narrative.html&title=Locked in the Narrative?" target="_blank"><img src="/images/reddit.png"></a>
    <a href="https://twitter.com/intent/tweet?via=epoberezkin&text=Locked%20in%20the%20Narrative%3F&hashtags=essay&original_referer=https%3A%2F%2Fwww.poberezkin.com%2Fposts%2F2019-05-31-locked-in-the-narrative.html&url=https%3A%2F%2Fwww.poberezkin.com%2Fposts%2F2019-05-31-locked-in-the-narrative.html" target="_blank"><img src="/images/tweet.png"></a>
    
  </section>
</article>
]]></summary>
</entry>
<entry>
    <title>Auditing development guidelines in GitHub repos</title>
    <link href="https://www.poberezkin.com/posts/2017-07-12-talk-auditing-development-guidelines-in-github-repositories.html" />
    <id>https://www.poberezkin.com/posts/2017-07-12-talk-auditing-development-guidelines-in-github-repositories.html</id>
    <published>2017-07-12T00:00:00Z</published>
    <updated>2017-07-12T00:00:00Z</updated>
    <summary type="html"><![CDATA[<article>
  <section class="header">
    <div class="info">
      Posted on
      
        <a href="https://skillsmatter.com/skillscasts/10399-auditing-development-guidelines-in-github-repositories">July 12, 2017</a>
      
      
        by Evgeny Poberezkin
      
    </div>
    <div class="info">
      
        Tags: <a title="All pages tagged &#39;talk&#39;." href="/tags/talk.html">talk</a>, <a title="All pages tagged &#39;github&#39;." href="/tags/github.html">github</a>, <a title="All pages tagged &#39;coding&#39;." href="/tags/coding.html">coding</a>, <a title="All pages tagged &#39;open-source&#39;." href="/tags/open-source.html">open-source</a>
      
    </div>
  </section>
  <section>
    <p>This is a <a href="https://skillsmatter.com/skillscasts/10399-auditing-development-guidelines-in-github-repositories">talk at FullStack London 2017</a>.</p>
<p><a href="https://skillsmatter.com/skillscasts/10399-auditing-development-guidelines-in-github-repositories"> <img src="/images/talk2017_2.jpg" alt="Auditing Development Guidelines in GitHub Repositories" width="100%"> </a></p>
<blockquote>
<p>If your organisation has hundreds of code repositories you probably have some guidelines for them: how they are documented, how branches are protected, whether direct commits to master branch are allowed or only PRs should be used and all PRs should be reviewed, whether tests are run and code coverage is reported to PRs, etc.</p>
</blockquote>
<blockquote>
<p>Making sure that those guidelines are followed is a difficult task - even if all team members agree to do so, sometimes we simply forget or don’t have time to implement the necessary changes.</p>
</blockquote>
<blockquote>
<p>Once we’ve agreed on our development guidelines, I was looking for a tool to automate such auditing for our team, so that in the same way as eslint can be used for testing code guidelines based on the rules, we could use this tool to audit our repositories in GitHub organisations. I couldn’t find one so I created it.</p>
</blockquote>
<blockquote>
<p>Meet <a href="https://github.com/MailOnline/gh-lint">gh-lint</a> - a rule-based command-line utility that audits all your GitHub repositories generating results in TAP (Test Anything Protocol) format that can be consumed by <a href="https://github.com/MailOnline/tap-github-issues">tap-github-issues</a> reporter that can create, update and close issues in GitHub repositories.</p>
</blockquote>
  </section>
  <section class="links">
    <a href="https://www.reddit.com/submit?url=https%3A%2F%2Fwww.poberezkin.com%2Fposts%2F2017-07-12-talk-auditing-development-guidelines-in-github-repositories.html&title=Auditing development guidelines in GitHub repos" target="_blank"><img src="/images/reddit.png"></a>
    <a href="https://twitter.com/intent/tweet?via=epoberezkin&text=Auditing%20development%20guidelines%20in%20GitHub%20repos&hashtags=talk%2Cgithub%2Ccoding%2Copen-source&original_referer=https%3A%2F%2Fwww.poberezkin.com%2Fposts%2F2017-07-12-talk-auditing-development-guidelines-in-github-repositories.html&url=https%3A%2F%2Fwww.poberezkin.com%2Fposts%2F2017-07-12-talk-auditing-development-guidelines-in-github-repositories.html" target="_blank"><img src="/images/tweet.png"></a>
    
      <a href="https://github.com/mailonline/gh-lint" target="_blank"><img src="/images/repo.png"></a>
    
  </section>
</article>
]]></summary>
</entry>
<entry>
    <title>WTF is Reactive Programming</title>
    <link href="https://www.poberezkin.com/posts/2017-04-28-talk-wtf-is-reactive-programming.html" />
    <id>https://www.poberezkin.com/posts/2017-04-28-talk-wtf-is-reactive-programming.html</id>
    <published>2017-04-28T00:00:00Z</published>
    <updated>2017-04-28T00:00:00Z</updated>
    <summary type="html"><![CDATA[<article>
  <section class="header">
    <div class="info">
      Posted on
      
        April 28, 2017
      
      
        by Evgeny Poberezkin
      
    </div>
    <div class="info">
      
        Tags: <a title="All pages tagged &#39;talk&#39;." href="/tags/talk.html">talk</a>, <a title="All pages tagged &#39;reactive&#39;." href="/tags/reactive.html">reactive</a>
      
    </div>
  </section>
  <section>
    <p>This is a <a href="https://www.infoq.com/presentations/reactive-programming-evolution/">talk at Progscon 2017</a>.</p>
<p>Slides are available in <a href="https://www.slideshare.net/epoberezkin/wtf-is-reactive-programming-75512905">slideshare</a>.</p>
<p><a href="https://www.infoq.com/presentations/reactive-programming-evolution/"> <img src="/images/talk2017_1.png" alt="WTF is Reactive Programming" width="100%"> </a></p>
<blockquote>
<p>This is a journey through the evolution of both the definition and implementations of Reactive Programming and how they have been converging in a quest to make building responsive applications a sane process.</p>
</blockquote>
<blockquote>
<p>We are still at the point where there is no complete consensus on what a reactive application is; I will explore how this consensus is evolving and what problems it brings.</p>
</blockquote>
<blockquote>
<p>I am going to talk about the past, present and possible futures of reactive programming and how you can survive it all.</p>
</blockquote>
  </section>
  <section class="links">
    <a href="https://www.reddit.com/submit?url=https%3A%2F%2Fwww.poberezkin.com%2Fposts%2F2017-04-28-talk-wtf-is-reactive-programming.html&title=WTF is Reactive Programming" target="_blank"><img src="/images/reddit.png"></a>
    <a href="https://twitter.com/intent/tweet?via=epoberezkin&text=WTF%20is%20Reactive%20Programming&hashtags=talk%2Creactive&original_referer=https%3A%2F%2Fwww.poberezkin.com%2Fposts%2F2017-04-28-talk-wtf-is-reactive-programming.html&url=https%3A%2F%2Fwww.poberezkin.com%2Fposts%2F2017-04-28-talk-wtf-is-reactive-programming.html" target="_blank"><img src="/images/tweet.png"></a>
    
  </section>
</article>
]]></summary>
</entry>
<entry>
    <title>TDD doesn’t work… Maybe CDD would?</title>
    <link href="https://www.poberezkin.com/posts/2017-02-19-tdd-doesnt-work-maybe-cdd-would.html" />
    <id>https://www.poberezkin.com/posts/2017-02-19-tdd-doesnt-work-maybe-cdd-would.html</id>
    <published>2017-02-19T00:00:00Z</published>
    <updated>2017-02-19T00:00:00Z</updated>
    <summary type="html"><![CDATA[<article>
  <section class="header">
    <div class="info">
      Posted on
      
        <a href="https://medium.com/@epoberezkin/tdd-doesnt-work-maybe-cdd-would-1fd756d2ca4b">February 19, 2017</a>
      
      
        by Evgeny Poberezkin
      
    </div>
    <div class="info">
      
        Tags: <a title="All pages tagged &#39;tests&#39;." href="/tags/tests.html">tests</a>, <a title="All pages tagged &#39;coding&#39;." href="/tags/coding.html">coding</a>
      
    </div>
  </section>
  <section>
    <p>Test Driven Development existed long before the term itself. It’s been “rediscovered” and popularised by Kent Beck, the creator of Extreme Programming. He wrote on Quora:</p>
<p><img src="/images/tdd1.png" alt="Kent Beck on Quora" title="...How else could you program?"></p>
<p>The complexity of software systems since those ancient times has evolved to a point when it is no longer possible to define the expected application behaviours in as simple terms as “the output tape you expect”.</p>
<p>The software development community is split, with opinions ranging from “<a href="https://dhh.dk/2014/tdd-is-dead-long-live-testing.html">TDD is dead. Long live testing</a>” (by <a href="https://dhh.dk/">David Heinemeier Hansson</a>, the creator of Ruby on Rails and the founder &amp; CTO of Basecamp):</p>
<blockquote>
<p><em>Test-first fundamentalism is like abstinence-only sex ed: An unrealistic, ineffective morality campaign for self-loathing and shaming.</em></p>
</blockquote>
<p>to “<a href="https://dzone.com/articles/whats-wrong-test-driven">What’s Wrong with Test-Driven Development (TDD)</a>”:</p>
<blockquote>
<p><em>[TDD] is a powerful methodology that helped me combat “analysis paralysis”, create robust, maintainable code and there’s the added benefit of the resulting unit tests which provide a safety-net against regression bugs.</em></p>
</blockquote>
<p>The latter one says that TDD is nearly perfect, we are simply doing it wrong, being scared to leave our comfort zones and to watch our tests fail… I wish it were as simple as that.</p>
<p><img src="/images/tdd2.png" alt="If it's so simple, why doesn't everybody doing it?" width="100%"></p>
<p>Really, why?</p>
<p>There is also no consensus about how software should be designed, even among developers who preach and practice TDD. Some moderate believers say that <a href="https://vladikk.com/2016/01/22/tdd-what-went-wrong/">TDD is NOT “Test Driven Design”</a>, that it should be used together with Domain Driven Design and call for reformation into TDD 2.0. Zealots insist that “<a href="https://dzone.com/articles/whats-wrong-test-driven">TDD is a design methodology - the unit tests are just a by-product of the process</a>”.</p>
<hr />
<p>Ok, let’s step back from the heat of the battle and ask ourselves what objectives we want to achieve, with or without TDD?</p>
<p>At a high level, software developers in both camps want to have lower costs of creating and using software. It means:</p>
<ol type="1">
<li>Reducing the number of bugs</li>
<li>Making changes with minimal regressions</li>
<li>Releasing changes with lower risk of failures</li>
<li>Maintaining code easily and running tests quickly</li>
<li>etc.</li>
</ol>
<p>We definitely need team-wide processes for the development project success. <a href="http://blog.cleancoder.com/uncle-bob/2014/06/17/IsTddDeadFinalThoughts.html">Uncle Bob writes</a> that if only a part of the team does TDD and another one doesn’t it will lead to divorce. But do we really need an industry-wide standard development process to achieve those objectives?</p>
<p>Software development projects are as diverse as businesses. As the complexity of the businesses was growing they in many cases transitioned from process management to <a href="https://en.wikipedia.org/wiki/Management_by_objectives">management by objectives</a>.</p>
<p>So what metrics in software development should we manage to achieve a higher level objective of reducing the costs?</p>
<p>I can see a strong inverse correlation between number of costly issues (bugs, regressions) and code coverage. That’s exactly the reason why a majority of popular open-source projects display this metric. A higher code coverage is usually seen as a higher reliability of the code, both by developers who follow TDD and those who don’t.</p>
<p><img src="/images/tdd3.png" alt="inverse correlation of bugs and code coverage" title="It's only a picture for 'inverse correlation', not the result of some research" width="100%"></p>
<hr />
<p>My development process aims to achieve an effective design and high code coverage. It could be called <strong>Coverage Driven Development</strong> and consists of three phases:</p>
<h3 id="plan-design">1. Plan &amp; Design</h3>
<p>I make a list of features and requirements for a both minimal and viable implementation that can be given to the end-users. The plan allows to foresee external dependencies and all requirements that the application should satisfy, and the design should be coordinated with this plan.</p>
<p>At this point there are no (or very few) external constraints to help structure the code. So I quickly iterate code to figure out how basic models, APIs, functions and classes should look. I am not worried if my code even works, and I usually don’t write tests during this phase, they only hinder the understanding of what the right design is.</p>
<p>Iterating code allows to avoid unnecessary intermediary abstractions that often plague TDD-written code and achieves a robust foundation of code structure. And it helps to transfer a visual image of the system that only exists in the the sketches or in the mind into the code and see if this picture still makes sense and whether it supports the whole plan. If it does, I go to the next phase, in not - I continue iterating the code until it does. Depending on the complexity of the system this phase can take from a couple of hours to a couple of days, or even weeks in a really big project.</p>
<h3 id="develop">2. Develop</h3>
<p>Before development continues, I write tests for all the code written in design phase to achieve code coverage of 95%+.</p>
<p>Each feature in the plan (that continues to evolve) requires some design thinking so I continue rapid code iteration and refactoring and in most cases I write tests only after code, getting to 95%+ code coverage before going to the next feature.</p>
<p>Depending on your quality requirements and the code size you can set a higher threshold for code coverage in your project, but the cost or writing and maintaining the tests grows very quickly as you approach 100%.</p>
<h3 id="maintain">3. Maintain</h3>
<p>This phase starts long before MVP is complete. In case when bugs are discovered or some simple changes should be made I almost always write a failing test BEFORE writing any code, exactly as TDD instructs. In this phase it just makes more sense. During the implementation of the fix I often discover some other issues and do some refactoring, but I don’t always write tests for them as I fix them - switching context damages focus and speed. Once the implementation is done I write additional tests to maintain code coverage at 95%+ level.</p>
<p><img src="/images/tdd4.png" alt="Coverage Driven Development phases" width="100%"></p>
<hr />
<p>This is not a linear process, it is a cycle that repeats multiple times, even before the application reaches the end-users. Also these phases are not strictly separated in time, they are more like “modes of operation” that can overlap.</p>
<p>The whole development process is driven by a single objective quality metric - code coverage. Uncle Bob sees TDD as a pre-requisite to achieving high code coverage (see “<a href="http://blog.cleancoder.com/uncle-bob/2014/06/17/IsTddDeadFinalThoughts.html#a-team-divided">Is TDD Dead?</a>”). But it’s not the case, you can maintain high code coverage without practicing TDD all the time.</p>
<p>You just need to follow several simple steps:</p>
<ol type="1">
<li>Implement code coverage measurement as early as possible.</li>
<li>Make the measurement run on every build.</li>
<li>Make coverage visible in your source code repository.</li>
<li>Make coverage change visible in PRs.</li>
<li>Only merge PRs if they increase the coverage or if it is already higher than the threshold agreed with the team for the project.</li>
</ol>
<p>Code coverage as a metric is not perfect, and I often hear the following criticism:</p>
<ol type="1">
<li>“It depends on code style”. It is true, but it does not reduce the efficiency of code coverage as quality metric. Adopting consistent code style for the team makes code coverage measurement consistent as well.</li>
<li>“100% coverage does not guarantee the absence of bugs”. It is also true, but neither does following TDD. No sufficiently complex system is free of bugs. While the absence of bugs is theoretically possible to achieve, and even possible to prove in some cases, it is prohibitively expensive. On the other hand maintaining high code coverage dramatically reduces the number of bugs and the probability of regressions.</li>
</ol>
<hr />
<p>If you are not using code coverage as part of your development process, it’s definitely worth trying. If nothing else, it will give you an increased satisfaction from writing tests. And all developers seem to agree that we should write tests to reduce the cost of software.</p>
<p><img src="/images/tdd5.png" alt="Acheived 100% code coverage" title="… but the bug is still there" max-width="100%"></p>
  </section>
  <section class="links">
    <a href="https://www.reddit.com/submit?url=https%3A%2F%2Fwww.poberezkin.com%2Fposts%2F2017-02-19-tdd-doesnt-work-maybe-cdd-would.html&title=TDD doesn’t work… Maybe CDD would?" target="_blank"><img src="/images/reddit.png"></a>
    <a href="https://twitter.com/intent/tweet?via=epoberezkin&text=TDD%20doesn%E2%80%99t%20work%E2%80%A6%20Maybe%20CDD%20would%3F&hashtags=tests%2Ccoding&original_referer=https%3A%2F%2Fwww.poberezkin.com%2Fposts%2F2017-02-19-tdd-doesnt-work-maybe-cdd-would.html&url=https%3A%2F%2Fwww.poberezkin.com%2Fposts%2F2017-02-19-tdd-doesnt-work-maybe-cdd-would.html" target="_blank"><img src="/images/tweet.png"></a>
    
  </section>
</article>
]]></summary>
</entry>
<entry>
    <title>Eval is evil, but not why you may think</title>
    <link href="https://www.poberezkin.com/posts/2016-09-10-eval-is-evil-but-not-why-you-may-think.html" />
    <id>https://www.poberezkin.com/posts/2016-09-10-eval-is-evil-but-not-why-you-may-think.html</id>
    <published>2016-09-10T00:00:00Z</published>
    <updated>2016-09-10T00:00:00Z</updated>
    <summary type="html"><![CDATA[<article>
  <section class="header">
    <div class="info">
      Posted on
      
        <a href="https://medium.com/mail-online/eval-is-evil-but-not-why-you-may-think-25961f9b01bb">September 10, 2016</a>
      
      
        by Evgeny Poberezkin
      
    </div>
    <div class="info">
      
        Tags: <a title="All pages tagged &#39;javascript&#39;." href="/tags/javascript.html">javascript</a>, <a title="All pages tagged &#39;coding&#39;." href="/tags/coding.html">coding</a>
      
    </div>
  </section>
  <section>
    <p>I have been hearing the mantra “eval is evil” for many years by now and none of the arguments presented to support it made any sense until very recently. Let’s explore the myths of eval, uncover the real evil behind it and find out the alternative way to reap eval’s benefits without its evilness.</p>
<p>All the code examples below are available in <a href="https://github.com/epoberezkin/eval-is-evil">eval-is-evil</a> repository.</p>
<h2 id="myth-1-eval-is-bad-for-performance">Myth #1: Eval Is Bad For Performance</h2>
<p>This statement is usually supported by some trivial example like this:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a><span class="kw">var</span> foo <span class="op">=</span> <span class="pp">eval</span>(<span class="st">&#39;bar.&#39;</span> <span class="op">+</span> x)<span class="op">;</span></span></code></pre></div>
<p>This code can be used to access bar object property which name is stored in the variable x. Instead, the author would argue, you should use the code below to access such property:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a><span class="kw">var</span> foo <span class="op">=</span> bar[x]<span class="op">;</span></span></code></pre></div>
<p>Although this way of using eval indeed reduces execution speed, I cannot imagine any JavaScript developer, however unexperienced, who would think of using eval in this case.</p>
<p>Let’s consider another example that also involves property accesses but <strong>where using <em>eval</em> dramatically improves performance</strong>.</p>
<p>We have some nested object and we need to define some transformation of this object to a shallow object. We want to define such transformation using configuration rather than just writing code. It can be preferable if we want to be able to dynamically change such configuration and in many other scenarios. So if our nested object looks something like this:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true"></a><span class="kw">var</span> source <span class="op">=</span> {</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true"></a>  <span class="dt">services</span><span class="op">:</span> {</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true"></a>    <span class="dt">db</span><span class="op">:</span> {</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true"></a>      <span class="dt">host</span><span class="op">:</span> <span class="st">&#39;db.example.com&#39;</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true"></a>    }<span class="op">,</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true"></a>    <span class="dt">audit</span><span class="op">:</span> {</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true"></a>      <span class="dt">host</span><span class="op">:</span> <span class="st">&#39;audit.example.com&#39;</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true"></a>    }</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true"></a>  }</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true"></a>}<span class="op">;</span></span></code></pre></div>
<p>and the shallow object we want to have should look this way:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true"></a><span class="kw">var</span> result <span class="op">=</span> {</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true"></a>  <span class="dt">db</span><span class="op">:</span> <span class="st">&#39;db.example.com&#39;</span><span class="op">,</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true"></a>  <span class="dt">audit</span><span class="op">:</span> <span class="st">&#39;audit.example.com&#39;</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true"></a>}<span class="op">;</span></span></code></pre></div>
<p>the transformation from nested to shallow object could look as this one:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true"></a><span class="kw">var</span> transformation <span class="op">=</span> {</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true"></a>  <span class="dt">db</span><span class="op">:</span> <span class="st">&#39;/services/db/host&#39;</span><span class="op">,</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true"></a>  <span class="dt">audit</span><span class="op">:</span> <span class="st">&#39;/services/audit/host&#39;</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true"></a>}<span class="op">;</span></span></code></pre></div>
<p>By the way, the format of the string defining the location of the data in the nested object is called <a href="https://tools.ietf.org/html/rfc6901">JSON pointer</a>.</p>
<p>Ok, so if we had such transformation, how would we write the code to transform a nested object to a shallow one? One approach is to simply iterate properties in the transformation and generate the resulting object:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true"></a><span class="kw">function</span> <span class="fu">transform</span>(source) {</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true"></a>  <span class="kw">var</span> result <span class="op">=</span> {}<span class="op">;</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true"></a>  <span class="cf">for</span> (<span class="kw">var</span> key <span class="kw">in</span> transformation) {</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true"></a>    <span class="kw">var</span> path <span class="op">=</span> transformation[key]<span class="op">;</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true"></a>    <span class="kw">var</span> segments <span class="op">=</span> path<span class="op">.</span><span class="fu">split</span>(<span class="st">&#39;/&#39;</span>)<span class="op">;</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true"></a>    <span class="kw">var</span> data <span class="op">=</span> source<span class="op">;</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true"></a>    <span class="cf">for</span> (<span class="kw">var</span> i<span class="op">=</span><span class="dv">1</span><span class="op">;</span> i<span class="op">&lt;</span>segments<span class="op">.</span><span class="at">length</span><span class="op">;</span> i<span class="op">++</span>) {</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true"></a>      data <span class="op">=</span> data <span class="op">&amp;&amp;</span> data[segments[i]]<span class="op">;</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true"></a>    }</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true"></a>    result[key] <span class="op">=</span> data<span class="op">;</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true"></a>  }</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true"></a>  <span class="cf">return</span> result<span class="op">;</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true"></a>}</span></code></pre></div>
<p>Although this code works, it is not very efficient if the transformation has to be performed on the server many times.</p>
<p>Another approach would be to <strong>generate</strong> the code that performs the transformation and convert this code into a function using eval (or Function constructor):</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true"></a><span class="kw">var</span> code <span class="op">=</span> <span class="st">&#39;return { &#39;</span><span class="op">;</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true"></a><span class="cf">for</span> (<span class="kw">var</span> key <span class="kw">in</span> transformation) {</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true"></a>  <span class="kw">var</span> path <span class="op">=</span> transformation[key]<span class="op">;</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true"></a>  <span class="kw">var</span> segments <span class="op">=</span> path<span class="op">.</span><span class="fu">split</span>(<span class="st">&#39;/&#39;</span>)<span class="op">;</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true"></a>  <span class="kw">var</span> data <span class="op">=</span> <span class="st">&#39;source&#39;</span><span class="op">;</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true"></a>  <span class="kw">var</span> expr <span class="op">=</span> data<span class="op">;</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true"></a>  <span class="cf">for</span> (<span class="kw">var</span> i<span class="op">=</span><span class="dv">1</span><span class="op">;</span> i<span class="op">&lt;</span>segments<span class="op">.</span><span class="at">length</span><span class="op">;</span> i<span class="op">++</span>) {</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true"></a>    data <span class="op">+=</span> <span class="st">&#39;.&#39;</span> <span class="op">+</span> segments[i]<span class="op">;</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true"></a>    expr <span class="op">+=</span> <span class="st">&#39; &amp;&amp; &#39;</span> <span class="op">+</span> data<span class="op">;</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true"></a>  }</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true"></a>  code <span class="op">+=</span> key <span class="op">+</span> <span class="st">&#39;: &#39;</span> <span class="op">+</span> expr <span class="op">+</span> <span class="st">&#39;, &#39;</span><span class="op">;</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true"></a>}</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true"></a>code <span class="op">+=</span> <span class="st">&#39;};&#39;</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true"></a></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true"></a><span class="kw">var</span> transform <span class="op">=</span> <span class="pp">eval</span>(<span class="st">&#39;(function(source) { &#39;</span> <span class="op">+</span> code <span class="op">+</span> <span class="st">&#39; })&#39;</span>)<span class="op">;</span></span></code></pre></div>
<p>The last line can be replaced with:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true"></a><span class="kw">var</span> transform <span class="op">=</span> <span class="kw">new</span> <span class="bu">Function</span>(<span class="st">&#39;source&#39;</span><span class="op">,</span> code)<span class="op">;</span></span></code></pre></div>
<p>For our transformation the generated function will be:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true"></a><span class="kw">function</span> (source) {</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true"></a>  <span class="cf">return</span> {</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true"></a>    <span class="dt">db</span><span class="op">:</span> source <span class="op">&amp;&amp;</span> source<span class="op">.</span><span class="at">services</span> <span class="op">&amp;&amp;</span> source<span class="op">.</span><span class="at">services</span><span class="op">.</span><span class="at">db</span> <span class="op">&amp;&amp;</span> source<span class="op">.</span><span class="at">services</span><span class="op">.</span><span class="at">db</span><span class="op">.</span><span class="at">host</span><span class="op">,</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true"></a>    <span class="dt">audit</span><span class="op">:</span> source <span class="op">&amp;&amp;</span> source<span class="op">.</span><span class="at">services</span> <span class="op">&amp;&amp;</span> source<span class="op">.</span><span class="at">services</span><span class="op">.</span><span class="at">audit</span> <span class="op">&amp;&amp;</span> source<span class="op">.</span><span class="at">services</span><span class="op">.</span><span class="at">audit</span><span class="op">.</span><span class="at">host</span><span class="op">,</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true"></a>  }<span class="op">;</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true"></a>}</span></code></pre></div>
<p>This dynamically generated code will execute many times faster than the first example where the transformation is performed using a loop. Creating this function takes some execution time but it happens only once.</p>
<p>This example shows that you can substantially improve the performance of your application using dynamic code generation and eval. The same approach is used for generating model accessor methods (get, set, etc.) in <a href="https://github.com/milojs/milo">milo.js</a> framework.</p>
<h2 id="myth-2-eval-is-security-risk">Myth #2: Eval Is Security Risk</h2>
<p>This statement probably assumes that you would receive JavaScript code in the request to the server and execute it using eval:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true"></a>app<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;/execute&#39;</span><span class="op">,</span> <span class="kw">function</span>(req<span class="op">,</span> res) {</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true"></a>  res<span class="op">.</span><span class="fu">send</span>(<span class="pp">eval</span>(req<span class="op">.</span><span class="at">body</span><span class="op">.</span><span class="at">code</span>))<span class="op">;</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true"></a>})<span class="op">;</span></span></code></pre></div>
<p>The code above indeed has some problems. If <code>req.body.code</code> were <code>process.exit(1)</code> the application would exit with error. Some worse things may easily happen too. But I cannot see how anybody could write code like this. User input is usually sanitised, particularly in cases when this input is used for code execution/generation.</p>
<p>Let’s consider another example. Say, we have a mass mailing application that sends the messages to the list of recipients and we require that the message that the user submits is a template using available fields from a recipient record:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true"></a><span class="kw">var</span> recipients <span class="op">=</span> [</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true"></a>  { <span class="dt">first_name</span><span class="op">:</span> <span class="st">&#39;John&#39;</span><span class="op">,</span> <span class="dt">last_name</span><span class="op">:</span> <span class="st">&#39;Smith&#39;</span> }<span class="op">,</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true"></a>  { <span class="dt">first_name</span><span class="op">:</span> <span class="st">&#39;Jane&#39;</span><span class="op">,</span> <span class="dt">last_name</span><span class="op">:</span> <span class="st">&#39;Doe&#39;</span> }</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true"></a>]<span class="op">;</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true"></a><span class="kw">var</span> messageTemplate <span class="op">=</span> <span class="st">&#39;Hello {{first_name}} {{last_name}}!&#39;</span><span class="op">;</span></span></code></pre></div>
<p>We could create the actual messages to all users in a loop:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true"></a><span class="kw">var</span> messages <span class="op">=</span> recipients<span class="op">.</span><span class="fu">map</span>(createMessage)<span class="op">;</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true"></a><span class="kw">function</span> <span class="fu">createMessage</span>(recipient) {</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true"></a>  <span class="cf">return</span> messageTemplate<span class="op">.</span><span class="fu">replace</span>(<span class="ss">/{{</span><span class="sc">([a-z_]+)</span><span class="ss">}}/ig</span><span class="op">,</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true"></a>    <span class="kw">function</span>(match<span class="op">,</span> key) {</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true"></a>      <span class="cf">return</span> recipients[key]<span class="op">;</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true"></a>    }</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true"></a>  )<span class="op">;</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true"></a>}</span></code></pre></div>
<p>The code above will create all the messages we need, but there is a much faster way to achieve it. We can generate the function createMessage. It doesn’t have any security implications even though messageTemplate is received from the user:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true"></a><span class="kw">var</span> code <span class="op">=</span> <span class="st">&#39;return &quot;&#39;</span><span class="op">;</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true"></a>code <span class="op">+=</span> messageTemplate<span class="op">.</span><span class="fu">replace</span>(<span class="ss">/{{</span><span class="sc">([a-z_]+)</span><span class="ss">}}/ig</span><span class="op">,</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true"></a>  <span class="kw">function</span>(match<span class="op">,</span> key) {</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true"></a>    <span class="cf">return</span> <span class="st">&#39;&quot; + data.&#39;</span> <span class="op">+</span> key <span class="op">+</span> <span class="st">&#39; + &quot;&#39;</span><span class="op">;</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true"></a>  }</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true"></a>)<span class="op">;</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true"></a>code <span class="op">+=</span> <span class="st">&#39;&quot;;&#39;</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true"></a><span class="kw">var</span> createMessage <span class="op">=</span> <span class="pp">eval</span>(<span class="st">&#39;(function(data) { &#39;</span> <span class="op">+</span> code <span class="op">+</span> <span class="st">&#39; })&#39;</span>)<span class="op">;</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true"></a><span class="co">// or new Function(&#39;data&#39;, code);</span></span></code></pre></div>
<p>In a few lines of code we have created a super-simple “templating engine” that compiles templates into JavaScript functions.</p>
<p>The template <code>"Hello {{first_name}} {{last_name}}!"</code> will be compiled to:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true"></a><span class="kw">function</span>(data) {</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true"></a>  <span class="cf">return</span> <span class="st">&quot;Hello &quot;</span> <span class="op">+</span> data<span class="op">.</span><span class="at">first_name</span> <span class="op">+</span> <span class="st">&quot; &quot;</span> <span class="op">+</span> data<span class="op">.</span><span class="at">last_name</span> <span class="op">+</span> <span class="st">&quot;!&quot;</span><span class="op">;</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true"></a>}</span></code></pre></div>
<p>Executing the function above is hundreds (if not thousands) times faster than the code that does not use eval. Creating this function is always safe — if some unsafe code is used inside curly braces it will not be executed because the regular expression won’t match. For example, the template</p>
<pre><code>&quot;Hello {{process.exit(1)}}!&quot;</code></pre>
<p>will generate this function:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true"></a><span class="kw">function</span>(data) {</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true"></a>  <span class="cf">return</span> <span class="st">&quot;Hello {{process.exit(1)}}!&quot;</span><span class="op">;</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true"></a>}</span></code></pre></div>
<p>i.e. an unsafe interpolation was not replaced with the code.</p>
<p>The same approach to compiling templates into JavaScript functions is used in the fastest and the most concise <a href="https://github.com/olado/doT">templating engine doT</a>.</p>
<h2 id="myth-3-eval-is-difficult-to-debug">Myth #3: Eval Is Difficult To Debug</h2>
<p>I am not sure where this is coming from. The code passed to eval is a normal JavaScript code — you can add breakpoints, inspect variables, etc. Debugging code passed to eval or to Function constructor is not that much different from debugging any JavaScript code, you just need to either format it during code generation or to use <a href="https://github.com/beautify-web/js-beautify">js-beautify</a> package.</p>
<p>Let’s consider one more example when you want to define a super-simple schema for your object (not <a href="http://json-schema.org/">JSON-schema</a>!) and validate it according to this schema:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true"></a><span class="kw">var</span> schema <span class="op">=</span> {</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true"></a>  <span class="dt">foo</span><span class="op">:</span> <span class="st">&#39;identifier&#39;</span><span class="op">,</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true"></a>  <span class="dt">bar</span><span class="op">:</span> <span class="st">&#39;date&#39;</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true"></a>}<span class="op">;</span></span></code></pre></div>
<p>We assume here that all properties should be strings and they should match some known formats (<code>identifier</code> and <code>date</code> in this case).</p>
<p>Our formats can be defined as regular expressions:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true"></a><span class="kw">var</span> formats <span class="op">=</span> {</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true"></a>  <span class="dt">identifier</span><span class="op">:</span> <span class="ss">/</span><span class="sc">^[a-z_$][a-z0-9_$]*$</span><span class="ss">/i</span><span class="op">,</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true"></a>  <span class="dt">date</span><span class="op">:</span> <span class="ss">/</span><span class="sc">^\d{2}\/\d{2}\/\d{4}$</span><span class="ss">/</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true"></a>}<span class="op">;</span></span></code></pre></div>
<p>The data that we want to validate:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true"></a><span class="kw">var</span> validData <span class="op">=</span> {</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true"></a>  <span class="dt">foo</span><span class="op">:</span> <span class="st">&#39;abc&#39;</span><span class="op">,</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true"></a>  <span class="dt">bar</span><span class="op">:</span> <span class="st">&#39;15/09/2016&#39;</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true"></a>}<span class="op">;</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true"></a><span class="kw">var</span> invalidData <span class="op">=</span> {</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true"></a>  <span class="dt">foo</span><span class="op">:</span> <span class="st">&#39;1&#39;</span><span class="op">,</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true"></a>  <span class="dt">bar</span><span class="op">:</span> <span class="st">&#39;15-09-2016&#39;</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true"></a>}<span class="op">;</span></span></code></pre></div>
<p>We can validate the data by iterating the properties in the schema and checking the data properties against the formats:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true"></a><span class="kw">function</span> <span class="fu">validate</span>(schema<span class="op">,</span> data) {</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true"></a>  <span class="cf">for</span> (<span class="kw">var</span> prop <span class="kw">in</span> schema) {</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true"></a>    <span class="kw">var</span> value <span class="op">=</span> data[prop]<span class="op">;</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true"></a>    <span class="cf">if</span> (<span class="kw">typeof</span> value <span class="op">!=</span> <span class="st">&#39;string&#39;</span>) <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true"></a>    <span class="kw">var</span> pattern <span class="op">=</span> formats[schema[prop]]<span class="op">;</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true"></a>    <span class="cf">if</span> (<span class="op">!</span>pattern<span class="op">.</span><span class="fu">test</span>(value)) <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true"></a>  }</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true"></a>  <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true"></a>}</span></code></pre></div>
<p>An alternative approach is to generate the code of the validating function from the schema and create this function using <em>eval</em>:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true"></a><span class="kw">var</span> code <span class="op">=</span> <span class="st">&#39;&#39;</span><span class="op">;</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true"></a><span class="cf">for</span> (<span class="kw">var</span> prop <span class="kw">in</span> schema) {</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true"></a>  <span class="kw">var</span> data <span class="op">=</span> <span class="st">&#39;data.&#39;</span> <span class="op">+</span> prop<span class="op">;</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true"></a>  code <span class="op">+=</span> <span class="st">&#39;if (typeof &#39;</span> <span class="op">+</span> data <span class="op">+</span> <span class="st">&#39; != &quot;string&quot;) return false;&#39;</span><span class="op">;</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true"></a>  code <span class="op">+=</span> <span class="st">&#39;if (!formats.&#39;</span> <span class="op">+</span> schema[prop] <span class="op">+</span> <span class="st">&#39;.test(&#39;</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true"></a>            <span class="op">+</span> data <span class="op">+</span> <span class="st">&#39;)) return false;&#39;</span><span class="op">;</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true"></a>}</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true"></a>code <span class="op">+=</span> <span class="st">&#39;return true;&#39;</span><span class="op">;</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true"></a><span class="kw">var</span> validate <span class="op">=</span> <span class="pp">eval</span>(<span class="st">&#39;(function(data) { &#39;</span> <span class="op">+</span> code <span class="op">+</span> <span class="st">&#39; })&#39;</span>)<span class="op">;</span></span></code></pre></div>
<p>Our simple schema above would “compile” to this function:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true"></a><span class="kw">function</span> (data) {</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true"></a>  <span class="cf">if</span> (<span class="kw">typeof</span> data<span class="op">.</span><span class="at">foo</span> <span class="op">!=</span> <span class="st">&quot;string&quot;</span>) <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true"></a>  <span class="cf">if</span> (<span class="op">!</span>formats<span class="op">.</span><span class="at">identifier</span><span class="op">.</span><span class="fu">test</span>(data<span class="op">.</span><span class="at">foo</span>)) <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true"></a>  <span class="cf">if</span> (<span class="kw">typeof</span> data<span class="op">.</span><span class="at">bar</span> <span class="op">!=</span> <span class="st">&quot;string&quot;</span>) <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true"></a>  <span class="cf">if</span> (<span class="op">!</span>formats<span class="op">.</span><span class="at">date</span><span class="op">.</span><span class="fu">test</span>(data<span class="op">.</span><span class="at">bar</span>)) <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true"></a>  <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true"></a>}</span></code></pre></div>
<p>This approach to data validation when the schema is compiled to a JavaScript function is used in several JSON-Schema validators, including the fastest one — <a href="https://github.com/epoberezkin/ajv">Ajv</a> that I have created.</p>
<h2 id="so-why-eval-is-evil">So Why Eval Is Evil?</h2>
<p><em>Eval</em> can dramatically improve performance, it doesn’t create security risks if used properly and it can be debugged without any problems. Why it should never be used then?</p>
<p>The problem with eval is that whenever eval creates a function, it becomes a closure that retains access to ALL variables in the current and in ALL parent scopes, regardless whether they are used by this closure or not. If you debug <code>validate</code> function from the third example in the chrome inspector you will see it:</p>
<p><img src="/images/eval1.png" alt="eval closure" title="eval creates big closure"></p>
<p>Unlike <em>eval</em>, <em>Function</em> constructor doesn’t have this problem, the function that it returns is created in the global scope and it is not a closure.</p>
<p>Vyacheslav Egorov <a href="https://mrale.ph/blog/2012/09/23/grokking-v8-closures-for-fun.html">wrote about it</a> 4 years ago and it is still the case today — eval is not optimised in node.js and browsers in the way normal closures are, that only retain access to the scope variables they use.</p>
<p>This issue has been pointed out by <a href="https://github.com/rf">Russ Frank</a> who has recently submitted a <a href="https://github.com/epoberezkin/ajv/pull/293">PR to Ajv</a> that replaced <em>eval</em> with <em>Function</em> constructor to reduce memory utilisation.</p>
<p>In all examples but the last one we could easily replace <em>eval</em> with <em>new Function</em>. In the last example though the generated function should be a closure — it needs access to <em>formats</em> that are defined in the parent scope. So if we simply use <em>Function</em> constructor in the same way as before it won’t work. Instead we can do this:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true"></a><span class="kw">var</span> createValidate <span class="op">=</span> <span class="kw">new</span> <span class="bu">Function</span>(<span class="st">&#39;formats&#39;</span><span class="op">,</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true"></a>                       <span class="st">&#39;return function(data) { &#39;</span> <span class="op">+</span> code <span class="op">+</span> <span class="st">&#39; }&#39;</span>)<span class="op">;</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true"></a><span class="kw">var</span> validate <span class="op">=</span> <span class="fu">createValidate</span>(formats)<span class="op">;</span></span></code></pre></div>
<p>As you can see <em>Function</em> constructor is used to create a function that returns a closure that has access to <em>formats</em>, but not to anything else:</p>
<p><img src="/images/eval2.png" alt="Function constructor closure" title="Function constructor allows to control closure"></p>
<p>Although this code is more verbose than with <em>eval</em> it doesn’t have the issue that makes <em>eval</em> really evil — <strong>retaining access to everything in all scopes</strong> from the current to the global.</p>
<p>So while code generation can be used to achieve serious performance benefits, direct calls to <em>eval</em> should be avoided. Instead <em>Function</em> constructor (or at least <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/eval">indirect calls</a> to <em>eval</em>) should be used.</p>
  </section>
  <section class="links">
    <a href="https://www.reddit.com/submit?url=https%3A%2F%2Fwww.poberezkin.com%2Fposts%2F2016-09-10-eval-is-evil-but-not-why-you-may-think.html&title=Eval is evil, but not why you may think" target="_blank"><img src="/images/reddit.png"></a>
    <a href="https://twitter.com/intent/tweet?via=epoberezkin&text=Eval%20is%20evil%2C%20but%20not%20why%20you%20may%20think&hashtags=javascript%2Ccoding&original_referer=https%3A%2F%2Fwww.poberezkin.com%2Fposts%2F2016-09-10-eval-is-evil-but-not-why-you-may-think.html&url=https%3A%2F%2Fwww.poberezkin.com%2Fposts%2F2016-09-10-eval-is-evil-but-not-why-you-may-think.html" target="_blank"><img src="/images/tweet.png"></a>
    
      <a href="https://github.com/epoberezkin/eval-is-evil" target="_blank"><img src="/images/repo.png"></a>
    
  </section>
</article>
]]></summary>
</entry>
<entry>
    <title>Batch API requests with JSONScript</title>
    <link href="https://www.poberezkin.com/posts/2016-07-13-talk-batch-execution-existing-endpoints-services-jsonscript.html" />
    <id>https://www.poberezkin.com/posts/2016-07-13-talk-batch-execution-existing-endpoints-services-jsonscript.html</id>
    <published>2016-07-13T00:00:00Z</published>
    <updated>2016-07-13T00:00:00Z</updated>
    <summary type="html"><![CDATA[<article>
  <section class="header">
    <div class="info">
      Posted on
      
        <a href="https://skillsmatter.com/skillscasts/8395-batch-execution-of-existing-endpoints-and-services-with-jsonscript">July 13, 2016</a>
      
      
        by Evgeny Poberezkin
      
    </div>
    <div class="info">
      
        Tags: <a title="All pages tagged &#39;talk&#39;." href="/tags/talk.html">talk</a>, <a title="All pages tagged &#39;javascript&#39;." href="/tags/javascript.html">javascript</a>, <a title="All pages tagged &#39;open-source&#39;." href="/tags/open-source.html">open-source</a>
      
    </div>
  </section>
  <section>
    <p>This is a <a href="https://skillsmatter.com/skillscasts/8395-batch-execution-of-existing-endpoints-and-services-with-jsonscript">talk at FullStack London 2016</a>.</p>
<p><a href="https://skillsmatter.com/skillscasts/8395-batch-execution-of-existing-endpoints-and-services-with-jsonscript"> <img src="/images/talk2016.jpg" alt="Batch API requests with JSONScript" width="100%"> </a></p>
<blockquote>
<p>A very common situation in web development: you need to make multiple requests, often with some conditions and logic between calls, to get the required result.</p>
</blockquote>
<blockquote>
<p>It can be achieved in three ways:</p>
</blockquote>
<blockquote>
<ol type="1">
<li>Sending multiple requests to the server and implementing all the processing logic in the client. The advantage of this approach is that the server remains unchanged and the client can easily change the logic and flow of requests. The disadvantage is the latency and the traffic - each request should travel via the network.</li>
<li>Implementing additional methods/endpoints/parameters in the server. The advantage of this approach is that the client has to make only one request. The disadvantage is that it requires changing the server (= coding + testing + documenting + deploying + monitoring + supporting…). When it is possible, it inevitably leads to the growing complexity of the remote system as more and more specialised methods/APIs are added to it.</li>
<li>Implement batch endpoints, e.g. using JSON RPC standard. While they allows to execute multiple calls in a single HTTP request, it doesn’t allow to implement any logic between the calls.</li>
</ol>
</blockquote>
<blockquote>
<p><a href="https://www.jsonscript.org/">JSONScript</a> is a simple tool that allows to create “a batch endpoint on steroids” - server-side scripted execution of existing endpoints and services.</p>
</blockquote>
<blockquote>
<p>It is currently implemented in express middleware that allows to add JSONScript batch endpoint in a single line of code.</p>
</blockquote>
  </section>
  <section class="links">
    <a href="https://www.reddit.com/submit?url=https%3A%2F%2Fwww.poberezkin.com%2Fposts%2F2016-07-13-talk-batch-execution-existing-endpoints-services-jsonscript.html&title=Batch API requests with JSONScript" target="_blank"><img src="/images/reddit.png"></a>
    <a href="https://twitter.com/intent/tweet?via=epoberezkin&text=Batch%20API%20requests%20with%20JSONScript&hashtags=talk%2Cjavascript%2Copen-source&original_referer=https%3A%2F%2Fwww.poberezkin.com%2Fposts%2F2016-07-13-talk-batch-execution-existing-endpoints-services-jsonscript.html&url=https%3A%2F%2Fwww.poberezkin.com%2Fposts%2F2016-07-13-talk-batch-execution-existing-endpoints-services-jsonscript.html" target="_blank"><img src="/images/tweet.png"></a>
    
      <a href="https://github.com/JSONScript/jsonscript" target="_blank"><img src="/images/repo.png"></a>
    
  </section>
</article>
]]></summary>
</entry>
<entry>
    <title>Validating data with JSON-schema</title>
    <link href="https://www.poberezkin.com/posts/2016-03-03-validating-data-with-json-schema.html" />
    <id>https://www.poberezkin.com/posts/2016-03-03-validating-data-with-json-schema.html</id>
    <published>2016-03-03T00:00:00Z</published>
    <updated>2016-03-03T00:00:00Z</updated>
    <summary type="html"><![CDATA[<article>
  <section class="header">
    <div class="info">
      Posted on
      
        March  3, 2016
      
      
        by Evgeny Poberezkin
      
    </div>
    <div class="info">
      
        Tags: <a title="All pages tagged &#39;json-schema&#39;." href="/tags/json-schema.html">json-schema</a>, <a title="All pages tagged &#39;tutorial&#39;." href="/tags/tutorial.html">tutorial</a>, <a title="All pages tagged &#39;coding&#39;." href="/tags/coding.html">coding</a>
      
    </div>
  </section>
  <section>
    <p>Tutsplus.com published my <a href="https://code.tutsplus.com/tutorials/validating-data-with-json-schema-part-1--cms-25343">2 part tutorial</a> on how to use JSON-schemas and also about some other related stuff:</p>
<ul>
<li>use schemas to define default values and to filter data</li>
<li>version 5 proposals for the JSON-schema standard</li>
<li>define custom validation keywords</li>
<li>JSON-schema validators comparison (so far my <a href="https://github.com/epoberezkin/ajv">Ajv</a> is ahead :)</li>
</ul>
  </section>
  <section class="links">
    <a href="https://www.reddit.com/submit?url=https%3A%2F%2Fwww.poberezkin.com%2Fposts%2F2016-03-03-validating-data-with-json-schema.html&title=Validating data with JSON-schema" target="_blank"><img src="/images/reddit.png"></a>
    <a href="https://twitter.com/intent/tweet?via=epoberezkin&text=Validating%20data%20with%20JSON-schema&hashtags=json-schema%2Ctutorial%2Ccoding&original_referer=https%3A%2F%2Fwww.poberezkin.com%2Fposts%2F2016-03-03-validating-data-with-json-schema.html&url=https%3A%2F%2Fwww.poberezkin.com%2Fposts%2F2016-03-03-validating-data-with-json-schema.html" target="_blank"><img src="/images/tweet.png"></a>
    
      <a href="https://github.com/epoberezkin/tutsplus-json-schema" target="_blank"><img src="/images/repo.png"></a>
    
  </section>
</article>
]]></summary>
</entry>
<entry>
    <title>Milo - The Reactive Javascript Framework</title>
    <link href="https://www.poberezkin.com/posts/2014-10-23-talk-milo-reactive-javascript-framework.html" />
    <id>https://www.poberezkin.com/posts/2014-10-23-talk-milo-reactive-javascript-framework.html</id>
    <published>2014-10-23T00:00:00Z</published>
    <updated>2014-10-23T00:00:00Z</updated>
    <summary type="html"><![CDATA[<article>
  <section class="header">
    <div class="info">
      Posted on
      
        <a href="https://skillsmatter.com/skillscasts/5857-milo-the-reactive-javascript-framework">October 23, 2014</a>
      
      
        by Jason Green and Evgeny Poberezkin
      
    </div>
    <div class="info">
      
        Tags: <a title="All pages tagged &#39;talk&#39;." href="/tags/talk.html">talk</a>, <a title="All pages tagged &#39;javascript&#39;." href="/tags/javascript.html">javascript</a>, <a title="All pages tagged &#39;open-source&#39;." href="/tags/open-source.html">open-source</a>, <a title="All pages tagged &#39;reactive&#39;." href="/tags/reactive.html">reactive</a>
      
    </div>
  </section>
  <section>
    <p>This is a <a href="https://skillsmatter.com/skillscasts/5857-milo-the-reactive-javascript-framework">talk at FullStack London 2014</a>.</p>
<p><a href="https://skillsmatter.com/skillscasts/5857-milo-the-reactive-javascript-framework"> <img src="/images/talk2014.jpg" alt="Milo - The Reactive Javascript Framework" width="100%"> </a></p>
<blockquote>
<p>We have a single page application. It means that we have data models and we have to react to changes in these models. We also need to propagate data through the different parts of the application and to update views when data changes.</p>
</blockquote>
<blockquote>
<p>There are quite a few frameworks that allow this on a basic level, but as the complexity of the application grows, the controller code becomes bloated with callbacks and glue code transferring data between models.</p>
</blockquote>
<blockquote>
<p>With Milo framework it takes just a few lines of code to create a reactive data graph capable of propagating, transforming and validating data between models and views of any depth.</p>
</blockquote>
<blockquote>
<p>In this talk we will explain the concepts and building blocks that make it possible, such as observable models, “DOM as data” and two-way data connectors. We will also build a simple TODO app and show how data-graph can be used in large-scale application architecture.</p>
</blockquote>
  </section>
  <section class="links">
    <a href="https://www.reddit.com/submit?url=https%3A%2F%2Fwww.poberezkin.com%2Fposts%2F2014-10-23-talk-milo-reactive-javascript-framework.html&title=Milo - The Reactive Javascript Framework" target="_blank"><img src="/images/reddit.png"></a>
    <a href="https://twitter.com/intent/tweet?via=epoberezkin&text=Milo%20-%20The%20Reactive%20Javascript%20Framework&hashtags=talk%2Cjavascript%2Copen-source%2Creactive&original_referer=https%3A%2F%2Fwww.poberezkin.com%2Fposts%2F2014-10-23-talk-milo-reactive-javascript-framework.html&url=https%3A%2F%2Fwww.poberezkin.com%2Fposts%2F2014-10-23-talk-milo-reactive-javascript-framework.html" target="_blank"><img src="/images/tweet.png"></a>
    
      <a href="https://github.com/milojs/milo" target="_blank"><img src="/images/repo.png"></a>
    
  </section>
</article>
]]></summary>
</entry>

</feed>
